<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZR Model Trainer v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); min-height: 100vh; padding: 15px; color: #e0e0e0; }
        .container { max-width: 1500px; margin: 0 auto; background: #1a1a2e; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid #333; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; border-radius: 16px 16px 0 0; position: relative; }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 0.95em; }
        .lang-toggle { position: absolute; top: 15px; right: 20px; display: flex; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.3); }
        .lang-btn { padding: 6px 14px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); border: none; cursor: pointer; font-weight: 600; font-size: 0.85em; transition: all 0.3s; }
        .lang-btn.active { background: rgba(255,255,255,0.3); color: white; }
        .lang-btn:hover { background: rgba(255,255,255,0.2); }
        .tabs { display: flex; background: #16213e; flex-wrap: wrap; border-bottom: 1px solid #333; overflow-x: auto; }
        .tab { flex: 1; min-width: 100px; padding: 12px 8px; text-align: center; cursor: pointer; background: #16213e; border: none; font-size: 0.85em; font-weight: 600; color: #888; transition: all 0.3s; white-space: nowrap; }
        .tab:hover { background: #1a1a2e; color: #aaa; }
        .tab.active { background: #1a1a2e; color: #667eea; border-bottom: 2px solid #667eea; }
        .tab-content { display: none; padding: 25px; max-height: 85vh; overflow-y: auto; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 18px; position: relative; }
        .form-group label { display: flex; align-items: center; gap: 6px; font-weight: 600; margin-bottom: 6px; color: #ccc; font-size: 0.9em; }
        .help-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: #667eea; color: white; font-size: 10px; font-weight: bold; cursor: help; position: relative; }
        .tooltip { display: none; position: absolute; background: #0a0a1a; color: #ddd; padding: 10px; border-radius: 8px; font-size: 11px; width: 280px; z-index: 1000; left: 100%; top: -10px; margin-left: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); line-height: 1.4; font-weight: normal; border: 1px solid #444; }
        .help-icon:hover .tooltip { display: block; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #444; border-radius: 8px; font-size: 0.95em; background: #16213e; color: #e0e0e0; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .recommended { font-size: 0.8em; color: #10b981; margin-top: 3px; }
        .btn { padding: 10px 24px; border: none; border-radius: 8px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 8px; margin-bottom: 8px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 4px 8px; font-size: 12px; min-width: auto; }
        .btn-outline { background: transparent; color: #667eea; border: 1px solid #667eea; }
        .btn-outline:hover { background: #667eea22; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .chart-container { position: relative; height: 300px; margin: 15px 0; background: #16213e; border-radius: 12px; padding: 15px; border: 1px solid #333; }
        .status-box { background: #16213e; border: 1px solid #333; border-radius: 12px; padding: 18px; margin-top: 15px; }
        .status-box h3 { color: #667eea; margin-bottom: 12px; font-size: 1em; }
        .status-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; }
        .status-label { font-weight: 600; color: #888; font-size: 0.9em; }
        .status-value { color: #e0e0e0; font-weight: 600; font-size: 0.9em; }
        .progress-bar { width: 100%; height: 24px; background: #222; border-radius: 12px; overflow: hidden; margin: 12px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8em; }
        .info-card { background: #16213e; border: 1px solid #333; border-radius: 12px; padding: 18px; margin-bottom: 12px; }
        .info-card h3 { color: #667eea; margin-bottom: 8px; font-size: 1em; }
        .info-card h4 { color: #ccc; margin: 12px 0 6px; font-size: 0.95em; }
        .info-card ul, .info-card ol { margin-left: 18px; line-height: 1.7; color: #aaa; font-size: 0.9em; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .alert-success { background: #10b98122; color: #10b981; border: 1px solid #10b981; }
        .alert-error { background: #ef444422; color: #ef4444; border: 1px solid #ef4444; }
        .alert-info { background: #667eea22; color: #667eea; border: 1px solid #667eea; }
        table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.9em; }
        table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        table th { color: #667eea; font-weight: 600; }
        table td { color: #ccc; }
        code { background: #0a0a1a; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #667eea; font-size: 0.85em; }
        .dataset-item { background: #0f0f23; border: 1px solid #333; border-radius: 8px; padding: 10px 14px; margin: 6px 0; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .catalog-card { background: #16213e; border: 1px solid #333; border-radius: 12px; padding: 16px; transition: all 0.3s; cursor: default; }
        .catalog-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .catalog-card h4 { color: #e0e0e0; margin-bottom: 4px; font-size: 0.95em; }
        .catalog-card .desc { color: #888; font-size: 0.8em; line-height: 1.4; margin: 6px 0; }
        .catalog-card .badges { display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: 600; }
        .badge-lang { background: #667eea33; color: #667eea; }
        .badge-size { background: #10b98133; color: #10b981; }
        .badge-cat { background: #f59e0b33; color: #f59e0b; }
        .badge-downloaded { background: #10b98133; color: #10b981; }
        .preset-card { background: #0f0f23; border: 2px solid #333; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .preset-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .preset-card.selected { border-color: #667eea; background: #667eea11; }
        .preset-card h4 { color: #e0e0e0; margin-bottom: 6px; }
        .preset-card .preset-desc { color: #888; font-size: 0.8em; }
        .preset-card .preset-specs { color: #667eea; font-size: 0.75em; margin-top: 6px; font-family: monospace; }
        .token-viz { line-height: 2; padding: 12px; }
        .token { display: inline-block; padding: 2px 4px; margin: 1px; border-radius: 3px; font-size: 0.9em; cursor: help; position: relative; }
        .token:hover::after { content: attr(data-info); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #0a0a1a; color: #ddd; padding: 6px 10px; border-radius: 6px; font-size: 0.75em; white-space: nowrap; z-index: 100; border: 1px solid #444; }
        .milestones { display: flex; justify-content: space-between; padding: 10px 0; margin: 10px 0; }
        .milestone { text-align: center; flex: 1; position: relative; }
        .milestone::before { content: ''; position: absolute; top: 12px; left: 0; right: 0; height: 2px; background: #333; z-index: 0; }
        .milestone.reached::before { background: #667eea; }
        .milestone-dot { width: 24px; height: 24px; border-radius: 50%; background: #333; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; position: relative; z-index: 1; margin-bottom: 4px; }
        .milestone.reached .milestone-dot { background: #667eea; color: white; }
        .milestone-label { font-size: 0.65em; color: #666; display: block; }
        .milestone.reached .milestone-label { color: #667eea; }
        .whats-happening { background: linear-gradient(135deg, #667eea11, #764ba211); border: 1px solid #667eea44; border-radius: 12px; padding: 16px; margin: 12px 0; display: none; }
        .whats-happening h4 { color: #667eea; margin-bottom: 8px; font-size: 0.9em; }
        .whats-happening p { color: #aaa; font-size: 0.85em; line-height: 1.5; }
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .compare-panel { background: #0f0f23; border: 1px solid #333; border-radius: 12px; padding: 15px; }
        .compare-panel h4 { color: #667eea; margin-bottom: 8px; font-size: 0.9em; }
        .compare-panel .text-output { color: #ccc; font-size: 0.85em; line-height: 1.6; min-height: 100px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border: 1px solid #444; border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h2 { color: #667eea; margin-bottom: 15px; }
        .modal p { color: #aaa; line-height: 1.6; margin-bottom: 12px; }
        .category-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .cat-btn { padding: 6px 14px; border-radius: 20px; border: 1px solid #444; background: transparent; color: #aaa; cursor: pointer; font-size: 0.8em; transition: all 0.2s; }
        .cat-btn:hover, .cat-btn.active { border-color: #667eea; color: #667eea; background: #667eea11; }
        .radar-container { height: 250px; }
        .search-box { display: flex; gap: 8px; margin-bottom: 15px; }
        .search-box input { flex: 1; }
        /* reward –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .reward-bar-row { margin: 7px 0; }
        .reward-bar-label { display: flex; justify-content: space-between; font-size: 0.82em; color: #ccc; margin-bottom: 3px; }
        .reward-bar-label .rbl-name { font-weight: 600; color: #aaa; }
        .reward-bar-label .rbl-val { color: #e0e0e0; }
        .reward-bar-label .rbl-delta { font-size: 0.85em; margin-left: 6px; }
        .reward-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; }
        .reward-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        /* live-–∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–π */
        .iter-card { background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 10px; padding: 12px 14px; margin-bottom: 8px; animation: fadeIn 0.4s ease; }
        .iter-card:first-child { border-color: #667eea; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:none; } }
        .iter-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .iter-card-num { font-weight: 700; color: #667eea; font-size: 0.85em; }
        .iter-card-time { font-size: 0.75em; color: #555; }
        .iter-card-metrics { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 6px; }
        .iter-metric { font-size: 0.8em; }
        .iter-metric .im-label { color: #666; }
        .iter-metric .im-val { font-weight: 700; color: #ccc; margin-left: 3px; }
        .iter-metric .im-delta { font-size: 0.85em; margin-left: 3px; }
        .iter-sample { font-size: 0.78em; color: #888; font-style: italic; border-left: 2px solid #333; padding-left: 8px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        /* —É–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ */
        .analysis-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid #1a1a2e; font-size: 0.85em; line-height: 1.4; }
        .analysis-item:last-child { border-bottom: none; }
        .analysis-icon { font-size: 1.1em; flex-shrink: 0; margin-top: 1px; }
        .analysis-text { color: #ccc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f23; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #667eea; }
        @media (max-width: 768px) {
            .compare-grid { grid-template-columns: 1fr; }
            .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AZR Model Trainer v2</h1>
            <p data-i18n="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ, –æ–±—É—á–∞–π—Ç–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏ –Ω–∞–≥–ª—è–¥–Ω–æ</p>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="switchLanguage('ru')" id="lang_ru">RU</button>
                <button class="lang-btn" onclick="switchLanguage('en')" id="lang_en">EN</button>
            </div>
        </div>

        <!-- GPU / CPU —Å—Ç–∞—Ç—É—Å-–±–∞—Ä -->
        <div id="gpu-banner" style="padding:10px 20px; display:flex; align-items:center; gap:12px; background:#0f0f23; border-bottom:1px solid #222; flex-wrap:wrap;">
            <div id="gpu-indicator" style="display:flex;align-items:center;gap:8px;">
                <span id="gpu-dot" style="width:10px;height:10px;border-radius:50%;background:#ef4444;display:inline-block;"></span>
                <span id="gpu-label" style="font-size:0.85em;font-weight:600;color:#aaa;" data-i18n="gpu_checking">–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</span>
            </div>
            <div id="gpu-install-area" style="display:none;flex:1;align-items:center;gap:10px;flex-wrap:wrap;">
                <button onclick="installGPU()" id="gpu-install-btn" class="btn btn-success" style="padding:6px 16px;font-size:0.8em;margin:0;" data-i18n="gpu_activate">‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å GPU</button>
                <div id="gpu-install-progress" style="display:none;flex:1;min-width:200px;">
                    <div class="progress-bar" style="height:16px;margin:0;">
                        <div id="gpu-progress-fill" class="progress-fill" style="width:0%;font-size:0.7em;">0%</div>
                    </div>
                    <div id="gpu-install-msg" style="font-size:0.75em;color:#aaa;margin-top:4px;"></div>
                </div>
            </div>
            <div id="gpu-restart-notice" style="display:none;background:#10b98122;border:1px solid #10b981;border-radius:8px;padding:6px 14px;font-size:0.8em;color:#10b981;" data-i18n="gpu_restart_msg">‚úÖ GPU —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('help')" data-i18n="tab_help">–ü–æ–º–æ—â—å</button>
            <button class="tab" onclick="showTab('catalog')" data-i18n="tab_catalog">–ö–∞—Ç–∞–ª–æ–≥</button>
            <button class="tab" onclick="showTab('create')" data-i18n="tab_create">–°–æ–∑–¥–∞—Ç—å</button>
            <button class="tab" onclick="showTab('datasets')" data-i18n="tab_datasets">–î–∞—Ç–∞—Å–µ—Ç—ã</button>
            <button class="tab" onclick="showTab('train')" data-i18n="tab_train">–û–±—É—á–µ–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('generate')" data-i18n="tab_generate">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</button>
            <button class="tab" onclick="showTab('compare')" data-i18n="tab_compare">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
            <button class="tab" onclick="showTab('models')" data-i18n="tab_models">–ú–æ–¥–µ–ª–∏</button>
        </div>

        <!-- –ü–û–ú–û–©–¨ -->
        <div id="help" class="tab-content active">
            <h2 data-i18n="quick_start">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h2>
            <div class="info-card">
                <h3 data-i18n="three_steps">3 —à–∞–≥–∞ –¥–æ –ø–µ—Ä–≤–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</h3>
                <ol>
                    <li data-i18n="step1"><strong>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç–∞—Å–µ—Ç</strong> ‚Äî –í–∫–ª–∞–¥–∫–∞ "–ö–∞—Ç–∞–ª–æ–≥" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –∏–ª–∏ —Ç–µ–∫—Å—Ç –∏ —Å–∫–∞—á–∞–π—Ç–µ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º</li>
                    <li data-i18n="step2"><strong>–°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª—å</strong> ‚Äî –í–∫–ª–∞–¥–∫–∞ "–°–æ–∑–¥–∞—Ç—å" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</li>
                    <li data-i18n="step3"><strong>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ</strong> ‚Äî –í–∫–ª–∞–¥–∫–∞ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å"</li>
                </ol>
                <p style="margin-top:10px;color:#10b981;" data-i18n="after_training_tip">–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è" –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ"</p>
            </div>
            <div class="info-card">
                <h3 data-i18n="whats_new">–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ v2</h3>
                <ul>
                    <li data-i18n="new_catalog"><strong>–ö–∞—Ç–∞–ª–æ–≥ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤</strong> ‚Äî 25+ –∫–Ω–∏–≥ –∏ —Ç–µ–∫—Å—Ç–æ–≤ + –ø–æ–∏—Å–∫ –ø–æ HuggingFace</li>
                    <li data-i18n="new_reinforce"><strong>REINFORCE</strong> ‚Äî –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è –Ω–∞ —Å–≤–æ–∏—Ö –æ—à–∏–±–∫–∞—Ö (policy gradient)</li>
                    <li data-i18n="new_metrics"><strong>6 –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞</strong> ‚Äî diversity, coherence, repetition, length, vocabulary, naturalness</li>
                    <li data-i18n="new_analytics"><strong>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</strong> ‚Äî –ø–µ—Ä–ø–ª–µ–∫—Å–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å, ETA, –±–µ–Ω—á–º–∞—Ä–∫–∏</li>
                    <li data-i18n="new_compare"><strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</strong> ‚Äî –∫–∞–∫ –º–æ–¥–µ–ª—å —É–ª—É—á—à–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–∏—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö</li>
                    <li data-i18n="new_confidence"><strong>Confidence</strong> ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ</li>
                    <li data-i18n="new_before_after"><strong>–î–æ/–ü–æ—Å–ª–µ</strong> ‚Äî –Ω–µ–æ–±—É—á–µ–Ω–Ω–∞—è vs –æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å</li>
                </ul>
            </div>
            <div class="info-card">
                <h3 data-i18n="configurations">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
                <table>
                    <tr><th data-i18n="th_goal">–¶–µ–ª—å</th><th>D Model</th><th>Layers</th><th>Iterations</th><th data-i18n="th_time">–í—Ä–µ–º—è</th></tr>
                    <tr><td data-i18n="preset_quick">–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç</td><td>128</td><td>4</td><td>1,000</td><td data-i18n="time_5min">~5 –º–∏–Ω</td></tr>
                    <tr><td data-i18n="preset_standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</td><td>256</td><td>6</td><td>10,000</td><td data-i18n="time_2h">~2 —á–∞—Å–∞</td></tr>
                    <tr><td data-i18n="preset_quality">–ö–∞—á–µ—Å—Ç–≤–æ</td><td>512</td><td>12</td><td>100,000</td><td data-i18n="time_24h">~24 —á–∞—Å–∞</td></tr>
                </table>
            </div>
            <div class="info-card">
                <h3>FAQ</h3>
                <p data-i18n="faq_loss"><strong>Loss –Ω–µ –ø–∞–¥–∞–µ—Ç?</strong> ‚Äî –£–º–µ–Ω—å—à–∏—Ç–µ learning rate –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –º–æ–¥–µ–ª—å.</p>
                <p data-i18n="faq_repeat"><strong>–ü–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç?</strong> ‚Äî Overfitting. –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –º–µ–Ω—å—à–µ –∏—Ç–µ—Ä–∞—Ü–∏–π.</p>
                <p data-i18n="faq_memory"><strong>Out of memory?</strong> ‚Äî –£–º–µ–Ω—å—à–∏—Ç–µ batch_size –∏–ª–∏ d_model.</p>
                <p data-i18n="faq_continue"><strong>–ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</strong> ‚Äî Stop, –ø–æ—Ç–æ–º –∑–∞–Ω–æ–≤–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —á–µ–∫–ø–æ–∏–Ω—Ç–∞.</p>
            </div>
        </div>

        <!-- –ö–ê–¢–ê–õ–û–ì -->
        <div id="catalog" class="tab-content">
            <h2 data-i18n="catalog_title">–ö–∞—Ç–∞–ª–æ–≥ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤</h2>
            <p style="color:#888;margin-bottom:15px;" data-i18n="catalog_desc">–°–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –Ω–∞ HuggingFace</p>
            <div class="category-filters" id="category_filters"></div>
            <div class="search-box">
                <input type="text" id="hf_search" placeholder="–ü–æ–∏—Å–∫ –Ω–∞ HuggingFace (–Ω–∞–ø—Ä–∏–º–µ—Ä: russian text, poetry, code)..." data-i18n-placeholder="hf_placeholder">
                <button class="btn btn-primary" onclick="searchHF()" data-i18n="btn_search_hf">–ü–æ–∏—Å–∫ HF</button>
            </div>
            <div class="search-box" style="margin-top:10px;">
                <input type="text" id="custom_url_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:0.3;" data-i18n-placeholder="placeholder_name">
                <input type="text" id="custom_url" placeholder="URL (https://...)" style="flex:0.5;">
                <select id="custom_url_lang" style="flex:0.15;padding:10px;background:#16213e;color:#e0e0e0;border:1px solid #444;border-radius:8px;">
                    <option value="auto">Auto</option><option value="ru">RU</option><option value="en">EN</option>
                </select>
                <button class="btn btn-success" onclick="addCustomURL()" data-i18n="btn_add_url">+ URL</button>
            </div>
            <div id="catalog_download_status" style="display:none;" class="alert alert-info"></div>
            <div class="grid-3" id="catalog_grid"></div>
        </div>

        <!-- –°–û–ó–î–ê–¢–¨ -->
        <div id="create" class="tab-content">
            <h2 data-i18n="btn_create_model">–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å</h2>
            <div class="info-card">
                <h3 data-i18n="choose_preset">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç</h3>
                <div class="grid-3">
                    <div class="preset-card" onclick="applyPreset('quick')" id="preset_quick">
                        <h4 data-i18n="preset_quick">–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç</h4>
                        <p class="preset-desc" data-i18n="preset_quick_desc">~5 –º–∏–Ω—É—Ç, –±–∞–∑–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</p>
                        <p class="preset-specs" data-i18n="preset_quick_specs">128d / 4 —Å–ª–æ—è / 1K –∏—Ç–µ—Ä</p>
                    </div>
                    <div class="preset-card" onclick="applyPreset('standard')" id="preset_standard">
                        <h4 data-i18n="preset_standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</h4>
                        <p class="preset-desc" data-i18n="preset_standard_desc">~2 —á–∞—Å–∞, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ</p>
                        <p class="preset-specs" data-i18n="preset_standard_specs">256d / 6 —Å–ª–æ—ë–≤ / 10K –∏—Ç–µ—Ä</p>
                    </div>
                    <div class="preset-card" onclick="applyPreset('quality')" id="preset_quality">
                        <h4 data-i18n="preset_quality">–ö–∞—á–µ—Å—Ç–≤–æ</h4>
                        <p class="preset-desc" data-i18n="preset_quality_desc">~24 —á–∞—Å–∞, –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                        <p class="preset-specs" data-i18n="preset_quality_specs">512d / 12 —Å–ª–æ—ë–≤ / 100K –∏—Ç–µ—Ä</p>
                    </div>
                </div>
                <div id="hw_recommendation" style="margin-top:10px;"></div>
            </div>
            <div class="form-group">
                <label data-i18n="model_name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏:</label>
                <input type="text" id="model_name" placeholder="my_model">
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Vocab Size: <span class="help-icon">?<span class="tooltip" data-i18n="tip_vocab">–†–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è. 10000-25000 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ.</span></span></label>
                    <input type="number" id="vocab_size" value="8000">
                </div>
                <div class="form-group">
                    <label>D Model: <span class="help-icon">?<span class="tooltip" data-i18n="tip_dmodel">–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏. –ë–æ–ª—å—à–µ = —É–º–Ω–µ–µ –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.</span></span></label>
                    <input type="number" id="d_model" value="256">
                </div>
                <div class="form-group">
                    <label>Num Layers: <span class="help-icon">?<span class="tooltip" data-i18n="tip_layers">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä-–±–ª–æ–∫–æ–≤. 4-12 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ.</span></span></label>
                    <input type="number" id="num_layers" value="6">
                </div>
                <div class="form-group">
                    <label>Num Heads: <span class="help-icon">?<span class="tooltip" data-i18n="tip_heads">Attention heads. –î–æ–ª–∂–Ω–æ –¥–µ–ª–∏—Ç—å d_model –Ω–∞—Ü–µ–ª–æ.</span></span></label>
                    <input type="number" id="num_heads" value="8">
                </div>
                <div class="form-group">
                    <label>D FF:</label>
                    <input type="number" id="d_ff" value="1024">
                </div>
                <div class="form-group">
                    <label>Max Seq Len:</label>
                    <input type="number" id="max_seq_len" value="256">
                </div>
            </div>
            <button class="btn btn-primary" onclick="createModel()" data-i18n="btn_create_model">–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å</button>
            <div id="create_status"></div>
        </div>

        <!-- –î–ê–¢–ê–°–ï–¢–´ -->
        <div id="datasets" class="tab-content">
            <h2 data-i18n="manage_datasets">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞–º–∏</h2>
            <div class="info-card">
                <h3 data-i18n="upload_files">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</h3>
                <input type="file" id="book_file" accept=".txt,.csv,.json,.jsonl,.pdf,.jpg,.jpeg,.png" onchange="uploadBook()" style="display:none;">
                <div style="display:flex;align-items:center;gap:12px;margin:10px 0;">
                    <button class="btn btn-outline" onclick="document.getElementById('book_file').click()" data-i18n="btn_choose_file">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                    <span id="chosen_file_name" style="color:#888;font-size:0.9em;" data-i18n="no_file_chosen">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                </div>
                <div class="recommended" data-i18n="supported_formats">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .txt, .csv, .json, .jsonl, .pdf, .jpg, .png</div>
                <div id="upload_status"></div>
            </div>
            <div class="info-card">
                <h3 data-i18n="manage">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <div class="form-group">
                    <label data-i18n="select_model">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:</label>
                    <select id="dataset_model_name" onchange="loadModelDatasets()"></select>
                </div>
                <h4 data-i18n="attached_datasets">–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫ –º–æ–¥–µ–ª–∏:</h4>
                <div id="attached_datasets"></div>
                <h4 style="margin-top:15px;" data-i18n="available_datasets">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã:</h4>
                <div id="available_datasets"></div>
            </div>
        </div>

        <!-- –û–ë–£–ß–ï–ù–ò–ï -->
        <div id="train" class="tab-content">
            <h2 data-i18n="training_title">–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</h2>
            <div class="form-group">
                <label data-i18n="select_model">–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å:</label>
                <select id="train_model_name"></select>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Max Iterations: <span class="help-icon">?<span class="tooltip" data-i18n="tip_iterations">1000=5–º–∏–Ω, 10000=2—á, 100000=24—á</span></span></label>
                    <input type="number" id="max_iterations" value="10000">
                </div>
                <div class="form-group">
                    <label>Batch Size:</label>
                    <input type="number" id="batch_size" value="16">
                </div>
                <div class="form-group">
                    <label>Learning Rate:</label>
                    <input type="number" id="learning_rate" value="0.0003" step="0.0001">
                </div>
                <div class="form-group">
                    <label>Save Every:</label>
                    <input type="number" id="save_every" value="1000">
                </div>
            </div>
            <button class="btn btn-primary" onclick="startTraining()" data-i18n="btn_start_training">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
            <button class="btn btn-success" onclick="resumeTraining()" data-i18n="btn_resume_training">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button class="btn btn-danger" onclick="stopTraining()" data-i18n="btn_stop_training">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <div id="live_gen_box" class="status-box" style="display:none;margin-top:15px;">
                <h3 data-i18n="live_generation">üîÆ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
                <div style="display:flex;gap:8px;margin-bottom:10px;">
                    <input type="text" id="live_gen_prompt" placeholder="–ü—Ä–∏–≤–µ—Ç" style="flex:1;" data-i18n-placeholder="prompt_placeholder">
                    <button class="btn btn-outline btn-sm" onclick="liveGenerate()" data-i18n="btn_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div id="live_gen_output" style="min-height:40px;padding:10px;background:#0a0a1a;border-radius:8px;color:#ccc;font-size:0.9em;" data-i18n="text_placeholder">–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
            </div>

            <div class="milestones" id="milestones">
                <div class="milestone" data-pct="1"><div class="milestone-dot">1</div><span class="milestone-label" data-i18n="ms_start">–°—Ç–∞—Ä—Ç</span></div>
                <div class="milestone" data-pct="5"><div class="milestone-dot">5</div><span class="milestone-label" data-i18n="ms_warmup">–†–∞–∑–æ–≥—Ä–µ–≤</span></div>
                <div class="milestone" data-pct="25"><div class="milestone-dot">25</div><span class="milestone-label" data-i18n="ms_quarter">–ß–µ—Ç–≤–µ—Ä—Ç—å</span></div>
                <div class="milestone" data-pct="50"><div class="milestone-dot">50</div><span class="milestone-label" data-i18n="ms_half">–ü–æ–ª–æ–≤–∏–Ω–∞</span></div>
                <div class="milestone" data-pct="75"><div class="milestone-dot">75</div><span class="milestone-label" data-i18n="ms_almost">–ü–æ—á—Ç–∏</span></div>
                <div class="milestone" data-pct="100"><div class="milestone-dot">!</div><span class="milestone-label" data-i18n="ms_done">–ì–æ—Ç–æ–≤–æ</span></div>
            </div>

            <div class="whats-happening" id="whats_happening">
                <h4 data-i18n="whats_happening">–ß—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç</h4>
                <p id="whats_happening_text"></p>
            </div>

            <div class="chart-container"><canvas id="trainingChart"></canvas></div>

            <div class="status-box">
                <h3 data-i18n="status_training">–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è</h3>
                <div class="status-item"><span class="status-label" data-i18n="status_label">–°—Ç–∞—Ç—É—Å:</span><span class="status-value" id="is_training" data-i18n="status_idle">–ù–µ –∑–∞–ø—É—â–µ–Ω–æ</span></div>
                <div class="progress-bar"><div class="progress-fill" id="progress" style="width:0%">0%</div></div>
                <div class="status-item"><span class="status-label" data-i18n="iteration_label">–ò—Ç–µ—Ä–∞—Ü–∏—è:</span><span class="status-value" id="current_iteration">0 / 0</span></div>
                <div class="status-item"><span class="status-label" data-i18n="loss_label">Loss:</span><span class="status-value" id="current_loss">--</span></div>
                <div class="status-item"><span class="status-label" data-i18n="reward_label">Reward:</span><span class="status-value" id="current_reward">--</span></div>
                <div class="status-item"><span class="status-label" data-i18n="perplexity_label">Perplexity:</span><span class="status-value" id="current_perplexity">--</span></div>
                <div class="status-item"><span class="status-label" data-i18n="speed_label">–°–∫–æ—Ä–æ—Å—Ç—å:</span><span class="status-value" id="tokens_per_sec">--</span></div>
                <div class="status-item"><span class="status-label" data-i18n="remaining_label">–û—Å—Ç–∞–ª–æ—Å—å:</span><span class="status-value" id="eta">--</span></div>
                <div class="status-item"><span class="status-label" data-i18n="memory_label">–ü–∞–º—è—Ç—å:</span><span class="status-value" id="memory_usage">--</span></div>
            </div>
            <!-- –£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑: —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å -->
            <div class="status-box" id="smart_analysis_box" style="display:none;">
                <h3 data-i18n="smart_analysis_title">üß† –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å</h3>
                <div id="smart_analysis_list"></div>
            </div>

            <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã reward ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã -->
            <div class="status-box" id="reward_components_box" style="display:none;">
                <h3 data-i18n="reward_components">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞–≥—Ä–∞–¥—ã</h3>
                <div id="reward_components_list"></div>
            </div>

            <!-- Live-–ª–µ–Ω—Ç–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π -->
            <div class="status-box" id="iteration_feed_box" style="display:none;">
                <h3 data-i18n="iteration_feed_title">üìç –ñ–∏–≤–∞—è –ª–µ–Ω—Ç–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π</h3>
                <div id="iteration_feed" style="max-height:320px;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- –ì–ï–ù–ï–†–ê–¶–ò–Ø -->
        <div id="generate" class="tab-content">
            <h2 data-i18n="generation_title">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞</h2>
            <div class="form-group">
                <label data-i18n="select_model">–ú–æ–¥–µ–ª—å:</label>
                <select id="gen_model_name"></select>
            </div>
            <div class="form-group">
                <label data-i18n="generate_prompt">–ü—Ä–æ–º–ø—Ç:</label>
                <textarea id="prompt" rows="2" placeholder="–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —ç—Ç–æ..." data-i18n-placeholder="prompt_placeholder"></textarea>
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Max Length:</label>
                    <input type="number" id="max_length" value="100">
                </div>
                <div class="form-group">
                    <label>Temperature: <span class="help-icon">?<span class="tooltip" data-i18n="tip_temperature">0.5=–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ, 1.0=–Ω–æ—Ä–º–∞, 1.5+=–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ</span></span></label>
                    <input type="number" id="temperature" value="0.8" step="0.1">
                </div>
                <div class="form-group">
                    <label>Top K:</label>
                    <input type="number" id="top_k" value="40">
                </div>
            </div>
            <button class="btn btn-primary" onclick="generateText()" data-i18n="btn_generate">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-success" onclick="generateBeforeAfter()" data-i18n="before_after">–î–æ / –ü–æ—Å–ª–µ</button>
            <div class="info-card" style="margin-top:15px;">
                <h3 data-i18n="generation_result">–†–µ–∑—É–ª—å—Ç–∞—Ç</h3> <span style="font-size:0.7em;color:#888;" data-i18n="confidence_hint">(—Ü–≤–µ—Ç = —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: –∑–µ–ª—ë–Ω—ã–π=–≤—ã—Å–æ–∫–∞—è, –∂—ë–ª—Ç—ã–π=—Å—Ä–µ–¥–Ω—è—è, –∫—Ä–∞—Å–Ω—ã–π=–Ω–∏–∑–∫–∞—è)</span>
                <div id="generated_output" class="token-viz" style="min-height:80px;" data-i18n="text_placeholder">–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
            </div>
            <div id="quality_radar_container" style="display:none;" class="info-card">
                <h3 data-i18n="quality_metrics">–ö–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
                <div class="radar-container"><canvas id="qualityRadar"></canvas></div>
            </div>
            <div id="before_after_container" style="display:none;">
                <h3 style="color:#667eea;margin:15px 0 10px;" data-i18n="before_vs_after">–î–æ –æ–±—É—á–µ–Ω–∏—è vs –ü–æ—Å–ª–µ</h3>
                <div class="compare-grid">
                    <div class="compare-panel"><h4 data-i18n="before_training">–î–æ –æ–±—É—á–µ–Ω–∏—è</h4><div id="before_text" class="text-output"></div><div id="before_quality" style="margin-top:8px;font-size:0.8em;color:#888;"></div></div>
                    <div class="compare-panel"><h4 data-i18n="after_training">–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è</h4><div id="after_text" class="text-output"></div><div id="after_quality" style="margin-top:8px;font-size:0.8em;color:#888;"></div></div>
                </div>
                <div id="improvement_summary" class="alert alert-success" style="margin-top:10px;display:none;"></div>
            </div>
        </div>

        <!-- –°–†–ê–í–ù–ï–ù–ò–ï -->
        <div id="compare" class="tab-content">
            <h2 data-i18n="compare_checkpoints">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–π</h2>
            <div class="form-group"><label data-i18n="select_model">–ú–æ–¥–µ–ª—å:</label><select id="compare_model_name" onchange="loadCheckpoints()"></select></div>
            <div class="grid">
                <div class="form-group"><label data-i18n="checkpoint_a_label">–ß–µ–∫–ø–æ–∏–Ω—Ç A:</label><select id="checkpoint_a"></select></div>
                <div class="form-group"><label data-i18n="checkpoint_b_label">–ß–µ–∫–ø–æ–∏–Ω—Ç B:</label><select id="checkpoint_b"></select></div>
            </div>
            <div class="form-group"><label data-i18n="compare_prompt_label">–ü—Ä–æ–º–ø—Ç:</label><input type="text" id="compare_prompt" value="–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç" data-i18n-value="compare_default_prompt"></div>
            <button class="btn btn-primary" onclick="compareCheckpoints()" data-i18n="btn_compare">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
            <div id="compare_results" style="display:none;margin-top:15px;">
                <div class="compare-grid">
                    <div class="compare-panel"><h4 id="compare_label_a">A</h4><div id="compare_text_a" class="text-output"></div><div id="compare_quality_a" style="margin-top:8px;font-size:0.8em;color:#888;"></div></div>
                    <div class="compare-panel"><h4 id="compare_label_b">B</h4><div id="compare_text_b" class="text-output"></div><div id="compare_quality_b" style="margin-top:8px;font-size:0.8em;color:#888;"></div></div>
                </div>
            </div>
            <div id="compare_radar_container" style="display:none;" class="info-card"><h3 data-i18n="compare_quality">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞</h3><div class="radar-container"><canvas id="compareRadar"></canvas></div></div>
            <div class="info-card" style="margin-top:15px;"><h3 data-i18n="iteration_history">–ò—Å—Ç–æ—Ä–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π</h3><button class="btn btn-outline" onclick="loadAnalyticsReports()" data-i18n="btn_load_reports">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç—ã</button><div id="analytics_table" style="margin-top:10px;"></div></div>
        </div>

        <!-- –ú–û–î–ï–õ–ò -->
        <div id="models" class="tab-content">
            <h2 data-i18n="my_models">–ú–æ–∏ –º–æ–¥–µ–ª–∏</h2>
            <button class="btn btn-success" onclick="loadModelsList()" data-i18n="btn_refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <div class="info-card" style="margin-top:15px;">
                <h3 data-i18n="upload_model_title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</h3>
                <div class="recommended" data-i18n="upload_model_hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ .pt —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ (state_dict –∏–ª–∏ –ø–æ–ª–Ω—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç)</div>
                <div style="display:flex;gap:10px;margin:10px 0;align-items:center;flex-wrap:wrap;">
                    <input type="text" id="upload_model_name" placeholder="my_model" style="width:200px;" data-i18n-placeholder="placeholder_name">
                    <input type="file" id="model_file_input" accept=".pt,.pth,.bin" style="display:none;" onchange="handleModelFileSelect()">
                    <button class="btn btn-outline" onclick="document.getElementById('model_file_input').click()" data-i18n="btn_choose_file">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                    <span id="model_file_name" style="color:#888;font-size:0.9em;" data-i18n="no_file_chosen">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                </div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="uploadModel()" data-i18n="btn_upload_model">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</button>
                    <span style="color:#666;">|</span>
                    <input type="file" id="tokenizer_file_input" accept=".pkl" style="display:none;" onchange="handleTokenizerSelect()">
                    <button class="btn btn-outline btn-sm" onclick="document.getElementById('tokenizer_file_input').click()" data-i18n="btn_upload_tokenizer">+ –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä (.pkl)</button>
                    <span id="tokenizer_file_name" style="color:#888;font-size:0.85em;"></span>
                </div>
                <div id="upload_model_status"></div>
            </div>
            <div id="models_list" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Wizard Modal -->
    <div class="modal-overlay" id="wizard_modal">
        <div class="modal">
            <h2 data-i18n="wizard_welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <p data-i18n="wizard_desc">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∑–∞ 3 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞.</p>
            <div class="grid-3" style="margin:20px 0;">
                <div class="preset-card" onclick="wizardSelectPreset('quick')"><h4 data-i18n="preset_quick">–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç</h4><p class="preset-desc" data-i18n="time_5min">5 –º–∏–Ω—É—Ç</p></div>
                <div class="preset-card" onclick="wizardSelectPreset('standard')"><h4 data-i18n="preset_standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</h4><p class="preset-desc" data-i18n="time_2h">2 —á–∞—Å–∞</p></div>
                <div class="preset-card" onclick="wizardSelectPreset('quality')"><h4 data-i18n="preset_quality">–ö–∞—á–µ—Å—Ç–≤–æ</h4><p class="preset-desc" data-i18n="time_24h">24 —á–∞—Å–∞</p></div>
            </div>
            <button class="btn btn-outline" onclick="closeWizard()" data-i18n="btn_skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal-overlay" id="preview_modal">
        <div class="modal">
            <h2 id="preview_title" data-i18n="preview">–ü—Ä–µ–≤—å—é</h2>
            <pre id="preview_content" style="color:#aaa;font-size:0.85em;line-height:1.5;max-height:400px;overflow-y:auto;white-space:pre-wrap;"></pre>
            <button class="btn btn-outline" onclick="closePreview()" style="margin-top:15px;" data-i18n="btn_close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
let trainingChart = null;
let chartData = { labels: [], loss: [], reward: [], perplexity: [] };
let statusInterval = null;
let downloadInterval = null;
let currentCategory = null;

const PRESETS = {
    quick:    { d_model: 128, num_layers: 4, num_heads: 4, d_ff: 512,  max_seq_len: 128, vocab_size: 10000,  max_iterations: 1000,  batch_size: 8,  learning_rate: 0.001 },
    standard: { d_model: 256, num_layers: 6, num_heads: 8, d_ff: 1024, max_seq_len: 256, vocab_size: 15000,  max_iterations: 10000, batch_size: 16, learning_rate: 0.0003 },
    quality:  { d_model: 512, num_layers: 12, num_heads: 16, d_ff: 2048, max_seq_len: 512, vocab_size: 25000, max_iterations: 100000, batch_size: 32, learning_rate: 0.0001 },
};

function getRewardLabels() {
    return {
        diversity: t('rl_diversity'), coherence: t('rl_coherence'), repetition_penalty: t('rl_repetition'),
        length_score: t('rl_length'), vocabulary_richness: t('rl_vocabulary'), bigram_naturalness: t('rl_naturalness')
    };
}
var REWARD_LABELS = {
    diversity: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ', coherence: '–ö–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å', repetition_penalty: '–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤',
    length_score: '–î–ª–∏–Ω–∞', vocabulary_richness: '–°–ª–æ–≤–∞—Ä—å', bigram_naturalness: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å'
};

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    if (tabName === 'catalog') loadCatalog();
    if (tabName === 'create') loadHWRecommendation();
    if (tabName === 'datasets') { loadModelsSelect(); loadDatasets(); }
    if (tabName === 'train') { loadModelsSelect(); initChart(); startStatusUpdates(); }
    if (tabName === 'generate') loadModelsSelect();
    if (tabName === 'compare') { loadModelsSelect(); }
    if (tabName === 'models') loadModelsList();
}

// === CATALOG ===
async function loadCatalog(category) {
    currentCategory = category || null;
    let url = '/dataset_catalog';
    if (category) url += '?category=' + category;
    const catResp = await fetch('/dataset_catalog/categories');
    const catData = await catResp.json();
    const filtersDiv = document.getElementById('category_filters');
    filtersDiv.innerHTML = '<button class="cat-btn ' + (!category ? 'active' : '') + '" onclick="loadCatalog()">' + t('filter_all') + '</button>' +
        catData.categories.map(c => '<button class="cat-btn ' + (category===c.id ? 'active' : '') + '" onclick="loadCatalog(\'' + c.id + '\')">' + c.icon + ' ' + (currentLang === 'en' ? (c.name || c.name_ru) : c.name_ru) + ' (' + c.count + ')</button>').join('');
    const resp = await fetch(url);
    const data = await resp.json();
    const grid = document.getElementById('catalog_grid');
    grid.innerHTML = data.datasets.map(d => {
        var title = currentLang === 'en' ? (d.name || d.name_ru) : (d.name_ru || d.name);
        var desc = currentLang === 'en' ? (d.description_en || d.description || '') : (d.description || '');
        return '<div class="catalog-card"><h4>' + title + '</h4><p class="desc">' + desc + '</p><div class="badges"><span class="badge badge-lang">' + d.language + '</span><span class="badge badge-size">' + d.size_estimate + '</span><span class="badge badge-cat">' + d.difficulty + '</span>' + (d.downloaded ? '<span class="badge badge-downloaded">' + t('already_downloaded') + '</span>' : '') + '</div><div style="margin-top:8px;">' + (d.downloaded ? '<button class="btn btn-outline" disabled>' + t('already_downloaded') + '</button>' : '<button class="btn btn-primary" onclick="downloadCatalogDS(\'' + d.id + '\')">' + t('btn_download_ds') + '</button>') + ' <button class="btn btn-outline" onclick="previewDS(\'' + d.id + '\')">' + t('btn_preview') + '</button></div></div>';
    }).join('');
}

async function downloadCatalogDS(id) {
    const statusDiv = document.getElementById('catalog_download_status');
    statusDiv.style.display = 'block';
    statusDiv.textContent = t('downloading');
    await fetch('/dataset_catalog/download/' + id, {method: 'POST'});
    downloadInterval = setInterval(async () => {
        const resp = await fetch('/dataset_catalog/download_status');
        const status = await resp.json();
        statusDiv.textContent = status.message || t('downloading');
        if (!status.is_downloading && status.progress !== 0) {
            clearInterval(downloadInterval);
            setTimeout(() => { statusDiv.style.display = 'none'; loadCatalog(currentCategory); }, 3000);
        }
    }, 1000);
}

async function previewDS(id) {
    document.getElementById('preview_content').textContent = t('loading');
    document.getElementById('preview_modal').classList.add('active');
    const resp = await fetch('/dataset_catalog/preview/' + id + '?lines=30');
    const data = await resp.json();
    document.getElementById('preview_title').textContent = data.name || t('preview');
    document.getElementById('preview_content').textContent = (data.lines || []).join('\n');
}
function closePreview() { document.getElementById('preview_modal').classList.remove('active'); }

async function searchHF() {
    const query = document.getElementById('hf_search').value;
    if (!query) return;
    const grid = document.getElementById('catalog_grid');
    grid.innerHTML = '<p style="color:#888;">' + t('searching') + '</p>';
    const resp = await fetch('/dataset_catalog/search_hf?query=' + encodeURIComponent(query) + '&limit=12');
    const data = await resp.json();
    if (data.results && data.results.length > 0 && !data.results[0].error) {
        grid.innerHTML = data.results.map(d => '<div class="catalog-card"><h4>' + d.name + '</h4><p class="desc">' + (d.description || 'HuggingFace dataset') + '</p><div class="badges"><span class="badge badge-cat">HuggingFace</span>' + (d.downloads ? '<span class="badge badge-size">' + d.downloads.toLocaleString() + ' downloads</span>' : '') + '</div></div>').join('');
    } else {
        grid.innerHTML = '<p style="color:#888;">' + t('nothing_found') + '</p>';
    }
}

async function addCustomURL() {
    var name = document.getElementById('custom_url_name').value;
    var url = document.getElementById('custom_url').value;
    var lang = document.getElementById('custom_url_lang').value;
    if (!name || !url) { alert(t('fill_name_url')); return; }
    var formData = new FormData();
    formData.append('name', name);
    formData.append('url', url);
    formData.append('language', lang);
    try {
        var resp = await fetch('/dataset_catalog/add_custom', { method: 'POST', body: formData });
        var data = await resp.json();
        if (data.status === 'added') {
            document.getElementById('custom_url_name').value = '';
            document.getElementById('custom_url').value = '';
            loadCatalog();
        }
    } catch(e) { alert('Error: ' + e.message); }
}

// === CREATE ===
function applyPreset(name) {
    const p = PRESETS[name];
    document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
    const el = document.getElementById('preset_' + name);
    if (el) el.classList.add('selected');
    Object.keys(p).forEach(key => { const e = document.getElementById(key); if (e) e.value = p[key]; });
}

async function loadHWRecommendation() {
    try {
        const resp = await fetch('/hardware_recommendation');
        const data = await resp.json();
        var reason = t(data.reason_key) || data.reason;
        if (data.reason_params) {
            Object.keys(data.reason_params).forEach(function(k) {
                reason = reason.replace('{' + k + '}', data.reason_params[k]);
            });
        }
        document.getElementById('hw_recommendation').innerHTML = '<div class="alert alert-info">' + t('hw_recommendation') + ': <strong>' + data.preset.toUpperCase() + '</strong> ‚Äî ' + reason + '</div>';
    } catch(e) {}
}

async function createModel() {
    const config = {
        name: document.getElementById('model_name').value,
        vocab_size: parseInt(document.getElementById('vocab_size').value),
        d_model: parseInt(document.getElementById('d_model').value),
        num_layers: parseInt(document.getElementById('num_layers').value),
        num_heads: parseInt(document.getElementById('num_heads').value),
        d_ff: parseInt(document.getElementById('d_ff').value),
        max_seq_len: parseInt(document.getElementById('max_seq_len').value)
    };
    if (!config.name) { alert(t('enter_model_name')); return; }
    try {
        const resp = await fetch('/create_model', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) });
        const data = await resp.json();
        document.getElementById('create_status').innerHTML = data.status === 'success'
            ? '<div class="alert alert-success">' + t('model_created') + data.parameters.toLocaleString() + '</div>'
            : '<div class="alert alert-error">' + (data.detail || 'Error') + '</div>';
    } catch(e) { document.getElementById('create_status').innerHTML = '<div class="alert alert-error">' + e.message + '</div>'; }
}

// === DATASETS ===
async function uploadBook() {
    const fileInput = document.getElementById('book_file');
    if (!fileInput.files[0]) return;
    document.getElementById('chosen_file_name').textContent = fileInput.files[0].name;
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        const resp = await fetch('/upload_book', { method: 'POST', body: formData });
        const data = await resp.json();
        if (data.status === 'success') {
            document.getElementById('upload_status').innerHTML = '<div class="alert alert-success">' + t('uploaded') + ': ' + data.filename + ' (' + (data.size/1024).toFixed(1) + ' KB)</div>';
            loadDatasets();
        }
    } catch(e) { document.getElementById('upload_status').innerHTML = '<div class="alert alert-error">' + e.message + '</div>'; }
}

async function loadModelsSelect() {
    const resp = await fetch('/models');
    const data = await resp.json();
    ['train_model_name', 'gen_model_name', 'dataset_model_name', 'compare_model_name'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        var prev = sel.value;
        sel.innerHTML = data.models.map(m => '<option value="' + m.name + '">' + m.name + '</option>').join('');
        if (prev && Array.from(sel.options).some(o => o.value === prev)) {
            sel.value = prev;
        }
    });
}

async function loadDatasets() {
    var modelSel = document.getElementById('dataset_model_name');
    var modelName = modelSel ? modelSel.value : '';
    if (!modelName) {
        // No model selected ‚Äî show all datasets with delete buttons
        var resp = await fetch('/books');
        var data = await resp.json();
        var div = document.getElementById('available_datasets');
        if (div) {
            div.innerHTML = data.books.map(function(b) {
                var n = b.name||b;
                return '<div class="dataset-item"><span>' + n + ' (' + ((b.size||0)/1024).toFixed(1) + ' KB)</span><button class="btn btn-danger btn-sm" onclick="deleteDS(\'' + n.replace(/'/g,"\\'") + '\')" title="' + t('btn_delete_ds') + '">‚úï</button></div>';
            }).join('') || '<p style="color:#666;">' + t('no_datasets') + '</p>';
        }
        var attDiv = document.getElementById('attached_datasets');
        if (attDiv) attDiv.innerHTML = '<p style="color:#666;">' + t('no_attached') + '</p>';
        return;
    }
    try {
        var resp2 = await fetch('/model_datasets/' + modelName);
        var md = await resp2.json();
        // Attached datasets
        var attDiv2 = document.getElementById('attached_datasets');
        if (attDiv2) {
            attDiv2.innerHTML = md.attached.map(function(d) {
                return '<div class="dataset-item"><span>' + d.name + ' (' + (d.size/1024).toFixed(1) + ' KB)</span><button class="btn btn-danger" onclick="detachDS(\'' + d.name.replace(/'/g,"\\'") + '\')">' + t('btn_detach') + '</button></div>';
            }).join('') || '<p style="color:#666;">' + t('no_attached') + '</p>';
        }
        // Available = only NOT attached
        var avDiv = document.getElementById('available_datasets');
        if (avDiv) {
            avDiv.innerHTML = md.available.map(function(b) {
                var n = b.name||b;
                return '<div class="dataset-item"><span>' + n + ' (' + ((b.size||0)/1024).toFixed(1) + ' KB)</span><div><button class="btn btn-primary" onclick="attachDS(\'' + n.replace(/'/g,"\\'") + '\')">' + t('btn_attach') + '</button> <button class="btn btn-danger btn-sm" onclick="deleteDS(\'' + n.replace(/'/g,"\\'") + '\')" title="' + t('btn_delete_ds') + '">‚úï</button></div></div>';
            }).join('') || '<p style="color:#666;">' + t('no_datasets') + '</p>';
        }
    } catch(e) { console.error('loadDatasets error:', e); }
}

async function loadModelDatasets() { loadDatasets(); }

async function attachDS(name) {
    var modelName = document.getElementById('dataset_model_name').value;
    await fetch('/attach_dataset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model_name: modelName, dataset_name: name})});
    loadDatasets();
}

async function detachDS(name) {
    var modelName = document.getElementById('dataset_model_name').value;
    await fetch('/detach_dataset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model_name: modelName, dataset_name: name})});
    loadDatasets();
}

async function deleteDS(name) {
    var msg = (t('confirm_delete_ds') || 'Delete dataset "{name}"?').replace('{name}', name);
    if (!confirm(msg)) return;
    await fetch('/delete_dataset/' + encodeURIComponent(name), { method:'DELETE' });
    loadDatasets();
}

// === TRAINING ===
function initChart() {
    if (trainingChart) return;
    const ctx = document.getElementById('trainingChart');
    if (!ctx) return;
    trainingChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                { label: 'Loss', data: chartData.loss, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, yAxisID: 'y' },
                { label: 'Reward', data: chartData.reward, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', tension: 0.4, yAxisID: 'y1' },
                { label: 'Perplexity', data: chartData.perplexity, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.4, yAxisID: 'y', borderDash: [5,5] }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', display: true, position: 'left', grid: {color:'#222'}, ticks: {color:'#888'} },
                y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea:false}, ticks: {color:'#888'} }
            },
            plugins: { legend: { labels: {color:'#aaa'} } }
        }
    });
}

function getTrainingConfig() {
    return {
        model_name: document.getElementById('train_model_name').value,
        max_iterations: parseInt(document.getElementById('max_iterations').value),
        batch_size: parseInt(document.getElementById('batch_size').value),
        learning_rate: parseFloat(document.getElementById('learning_rate').value),
        save_every: parseInt(document.getElementById('save_every').value)
    };
}

async function startTraining() {
    var config = getTrainingConfig();
    try {
        const resp = await fetch('/train', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(config)});
        const data = await resp.json();
        if (data.status === 'success') { startStatusUpdates(); document.getElementById('live_gen_box').style.display = 'block'; }
        else { alert(data.detail || 'Error'); }
    } catch(e) { alert(e.message); }
}

async function resumeTraining() {
    var config = getTrainingConfig();
    config.resume = true;
    try {
        const resp = await fetch('/train', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(config)});
        const data = await resp.json();
        if (data.status === 'success') { startStatusUpdates(); document.getElementById('live_gen_box').style.display = 'block'; }
        else { alert(data.detail || 'Error'); }
    } catch(e) { alert(e.message); }
}

async function stopTraining() { await fetch('/stop_training', {method:'POST'}); }

var liveGenInterval = null;
async function liveGenerate() {
    var model = document.getElementById('train_model_name').value;
    var prompt = document.getElementById('live_gen_prompt').value || '–ü—Ä–∏–≤–µ—Ç';
    var el = document.getElementById('live_gen_output');
    el.innerHTML = '<span style="color:#888;">' + t('generating') + '</span>';
    try {
        var resp = await fetch('/generate_live', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model_name: model, prompt: prompt, max_length: 60, temperature: 0.9})});
        if (!resp.ok) { el.textContent = 'Error: ' + resp.status; return; }
        var data = await resp.json();
        el.textContent = data.generated_text || 'N/A';
    } catch(e) { el.textContent = 'Error: ' + e.message; }
}

function startStatusUpdates() {
    if (statusInterval) clearInterval(statusInterval);
    updateTrainingStatus();
    statusInterval = setInterval(updateTrainingStatus, 2000);
}

function formatETA(s) {
    if (s < 0) return '--';
    if (s < 60) return s + ' ' + t('eta_sec');
    if (s < 3600) return Math.floor(s/60) + ' ' + t('eta_min');
    return Math.floor(s/3600) + t('eta_h') + ' ' + Math.floor((s%3600)/60) + t('eta_m');
}

function updateMilestones(pct) {
    document.querySelectorAll('.milestone').forEach(m => {
        m.classList.toggle('reached', pct >= parseInt(m.dataset.pct));
    });
}

function updateWhatsHappening(s) {
    const el = document.getElementById('whats_happening');
    const txt = document.getElementById('whats_happening_text');
    if (!s.is_training) { el.style.display = 'none'; return; }
    el.style.display = 'block';
    const p = s.max_iterations > 0 ? s.current_iteration / s.max_iterations : 0;
    const loss = s.current_loss || 0;
    const reward = s.current_reward || 0;
    let msg = '';
    if (p < 0.03) msg = t('wh_start');
    else if (p < 0.15) msg = 'Loss: ' + loss.toFixed(2) + '. ' + t('wh_early');
    else if (p < 0.4)  msg = t('wh_mid') + ' Reward: ' + reward.toFixed(3);
    else if (p < 0.7)  msg = t('wh_late');
    else if (p < 0.95) msg = t('wh_final');
    else               msg = t('wh_done');
    txt.textContent = msg;
}

// ‚îÄ‚îÄ –£–ú–ù–´–ô –ê–ù–ê–õ–ò–ó "—á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _prevStatus = null;
var _lossHistory = [];   // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–Ω–∞—á–µ–Ω–∏–π loss
var _rewardHistory = []; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–Ω–∞—á–µ–Ω–∏–π reward

function updateSmartAnalysis(s) {
    if (!s.is_training || !s.current_iteration) return;

    // –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    if (s.current_loss) {
        _lossHistory.push(s.current_loss);
        if (_lossHistory.length > 20) _lossHistory.shift();
    }
    if (s.current_reward) {
        _rewardHistory.push(s.current_reward);
        if (_rewardHistory.length > 20) _rewardHistory.shift();
    }

    const box = document.getElementById('smart_analysis_box');
    const list = document.getElementById('smart_analysis_list');
    if (!box || !list) return;
    box.style.display = 'block';

    const items = [];

    // –ê–Ω–∞–ª–∏–∑ loss
    if (_lossHistory.length >= 5) {
        const recent  = _lossHistory.slice(-5).reduce((a,b) => a+b,0) / 5;
        const older   = _lossHistory.slice(0, 5).reduce((a,b) => a+b,0) / 5;
        const lossChg = ((recent - older) / older * 100);
        if (lossChg < -5) {
            items.push({icon:'‚úÖ', text: t('an_loss_down').replace('{n}', Math.abs(lossChg).toFixed(1))});
        } else if (lossChg > 3) {
            items.push({icon:'‚ö†Ô∏è', text: t('an_loss_up').replace('{n}', lossChg.toFixed(1))});
        } else {
            items.push({icon:'üìä', text: t('an_loss_stable').replace('{n}', recent.toFixed(3))});
        }
    }

    // –ê–Ω–∞–ª–∏–∑ reward
    if (_rewardHistory.length >= 5) {
        const rRecent = _rewardHistory.slice(-5).reduce((a,b) => a+b,0) / 5;
        const rOlder  = _rewardHistory.slice(0,5).reduce((a,b) => a+b,0) / 5;
        if (rOlder > 0) {
            const rChg = ((rRecent - rOlder) / rOlder * 100);
            if (rChg > 5)  items.push({icon:'üìà', text: t('an_rew_up').replace('{n}', rChg.toFixed(1))});
            else if (rChg < -5) items.push({icon:'üìâ', text: t('an_rew_down').replace('{n}', Math.abs(rChg).toFixed(1))});
            else items.push({icon:'üéØ', text: t('an_rew_stable').replace('{n}', rRecent.toFixed(3))});
        }
    }

    // Val loss ‚Äî –æ–≤–µ—Ä—Ñ–∏—Ç
    if (s.val_loss && s.current_loss) {
        const ratio = s.val_loss / s.current_loss;
        if (ratio > 1.15) {
            items.push({icon:'üî¥', text: t('an_overfit_hi').replace('{v}', s.val_loss.toFixed(3)).replace('{t}', s.current_loss.toFixed(3))});
        } else if (ratio > 1.05) {
            items.push({icon:'üü°', text: t('an_overfit_mid')});
        } else {
            items.push({icon:'üü¢', text: t('an_overfit_ok')});
        }
    }

    // –°–∫–æ—Ä–æ—Å—Ç—å
    if (s.tokens_per_sec > 0) {
        const dev = s.device === 'cuda' ? 'üöÄ GPU' : 'üê¢ CPU';
        items.push({icon:'‚ö°', text: t('an_device').replace('{dev}', dev).replace('{n}', s.tokens_per_sec.toFixed(0))});
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã reward ‚Äî —á—Ç–æ —Ö—É–∂–µ/–ª—É—á—à–µ –≤—Å–µ–≥–æ
    if (s.reward_components) {
        const comps = Object.entries(s.reward_components);
        const sorted = [...comps].sort((a,b) => a[1]-b[1]);
        const worst = sorted[0];
        const best  = sorted[sorted.length - 1];
        if (worst) items.push({icon:'üí°', text: t('an_weak').replace('{comp}', REWARD_LABELS[worst[0]]||worst[0]).replace('{n}', worst[1].toFixed(3))});
        if (best)  items.push({icon:'üèÜ', text: t('an_best').replace('{comp}', REWARD_LABELS[best[0]]||best[0]).replace('{n}', best[1].toFixed(3))});
    }

    list.innerHTML = items.map(i =>
        `<div class="analysis-item"><span class="analysis-icon">${i.icon}</span><span class="analysis-text">${i.text}</span></div>`
    ).join('');

    _prevStatus = s;
}

// ‚îÄ‚îÄ REWARD –ö–û–ú–ü–û–ù–ï–ù–¢–´ ‚Äî –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _prevRewardComponents = {};

function updateRewardComponents(s) {
    if (!s.reward_components || !Object.keys(s.reward_components).length) return;
    const box  = document.getElementById('reward_components_box');
    const list = document.getElementById('reward_components_list');
    if (!box || !list) return;
    box.style.display = 'block';

    const colors = {
        diversity:           '#667eea',
        coherence:           '#10b981',
        repetition_penalty:  '#f59e0b',
        length_score:        '#3b82f6',
        vocabulary_richness: '#8b5cf6',
        bigram_naturalness:  '#ec4899'
    };

    list.innerHTML = Object.entries(s.reward_components).map(([key, val]) => {
        const label = REWARD_LABELS[key] || key;
        const pct   = Math.min(100, Math.max(0, val * 100)).toFixed(0);
        const color = colors[key] || '#667eea';
        const prev  = _prevRewardComponents[key];
        let deltaHtml = '';
        if (prev !== undefined) {
            const d = val - prev;
            if (Math.abs(d) > 0.001) {
                const sign  = d > 0 ? '+' : '';
                const dColor = d > 0 ? '#10b981' : '#ef4444';
                deltaHtml = `<span class="rbl-delta" style="color:${dColor}">${sign}${d.toFixed(3)}</span>`;
            }
        }
        return `<div class="reward-bar-row">
            <div class="reward-bar-label">
                <span class="rbl-name">${label}</span>
                <span class="rbl-val">${val.toFixed(3)} ${deltaHtml}</span>
            </div>
            <div class="reward-bar-bg">
                <div class="reward-bar-fill" style="width:${pct}%;background:${color};"></div>
            </div>
        </div>`;
    }).join('');

    _prevRewardComponents = {...s.reward_components};
}

// ‚îÄ‚îÄ LIVE-–õ–ï–ù–¢–ê –ò–¢–ï–†–ê–¶–ò–ô ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var _lastFeedIteration = 0;
var _feedInterval = 200; // –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–∂–¥—ã–µ 200 –∏—Ç–µ—Ä–∞—Ü–∏–π

function updateIterationFeed(s) {
    if (!s.is_training || !s.current_iteration) return;
    if (s.current_iteration - _lastFeedIteration < _feedInterval) return;
    _lastFeedIteration = s.current_iteration;

    const box  = document.getElementById('iteration_feed_box');
    const feed = document.getElementById('iteration_feed');
    if (!box || !feed) return;
    box.style.display = 'block';

    const loss   = s.current_loss   ? s.current_loss.toFixed(4)   : '--';
    const reward = s.current_reward ? s.current_reward.toFixed(4) : '--';
    const ppl    = s.perplexity     ? s.perplexity.toFixed(1)     : '--';
    const spd    = s.tokens_per_sec ? s.tokens_per_sec.toFixed(0) + ' tok/s' : '--';
    const now    = new Date().toLocaleTimeString();

    // –î–µ–ª—å—Ç—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π
    const prevLoss   = _prevStatus ? (_prevStatus.current_loss   || 0) : 0;
    const prevReward = _prevStatus ? (_prevStatus.current_reward || 0) : 0;
    const lossDelta   = prevLoss   ? ((s.current_loss   - prevLoss)   / prevLoss   * 100) : 0;
    const rewardDelta = prevReward ? ((s.current_reward - prevReward) / prevReward * 100) : 0;

    function deltaSpan(d, invert) {
        if (!d || Math.abs(d) < 0.1) return '';
        const good  = invert ? d < 0 : d > 0;
        const color = good ? '#10b981' : '#ef4444';
        const sign  = d > 0 ? '‚ñ≤' : '‚ñº';
        return `<span style="color:${color};font-size:0.8em;margin-left:3px;">${sign}${Math.abs(d).toFixed(1)}%</span>`;
    }

    const card = document.createElement('div');
    card.className = 'iter-card';
    card.innerHTML = `
        <div class="iter-card-header">
            <span class="iter-card-num">üìç ${t('iter_label')} ${s.current_iteration.toLocaleString()}</span>
            <span class="iter-card-time">${now}</span>
        </div>
        <div class="iter-card-metrics">
            <div class="iter-metric">
                <span class="im-label">Loss</span>
                <span class="im-val">${loss}</span>${deltaSpan(lossDelta, true)}
            </div>
            <div class="iter-metric">
                <span class="im-label">Reward</span>
                <span class="im-val">${reward}</span>${deltaSpan(rewardDelta, false)}
            </div>
            <div class="iter-metric">
                <span class="im-label">Perplexity</span>
                <span class="im-val">${ppl}</span>
            </div>
            <div class="iter-metric">
                <span class="im-label">${t('speed_short')}</span>
                <span class="im-val">${spd}</span>
            </div>
        </div>`;

    feed.insertBefore(card, feed.firstChild);

    // –ú–∞–∫—Å–∏–º—É–º 15 –∫–∞—Ä—Ç–æ—á–µ–∫
    while (feed.children.length > 15) feed.removeChild(feed.lastChild);
}

async function updateTrainingStatus() {
    try {
        const resp = await fetch('/training_status');
        const s = await resp.json();
        document.getElementById('is_training').textContent = s.is_training ? t('training_active') : t('training_idle');
        document.getElementById('is_training').style.color = s.is_training ? '#10b981' : '#888';
        document.getElementById('live_gen_box').style.display = s.is_training ? 'block' : 'none';
        const pct = s.max_iterations > 0 ? (s.current_iteration / s.max_iterations * 100) : 0;
        document.getElementById('progress').style.width = pct.toFixed(1) + '%';
        document.getElementById('progress').textContent = pct.toFixed(1) + '%';
        document.getElementById('current_iteration').textContent = s.current_iteration + ' / ' + s.max_iterations;
        document.getElementById('current_loss').textContent = s.current_loss ? s.current_loss.toFixed(4) : '--';
        document.getElementById('current_reward').textContent = s.current_reward ? s.current_reward.toFixed(4) : '--';
        document.getElementById('current_perplexity').textContent = s.perplexity ? s.perplexity.toFixed(1) : '--';
        document.getElementById('tokens_per_sec').textContent = s.tokens_per_sec ? s.tokens_per_sec.toFixed(0) + ' tok/s' : '--';
        document.getElementById('eta').textContent = formatETA(s.eta_seconds || -1);
        document.getElementById('memory_usage').textContent = s.memory_mb ? s.memory_mb.toFixed(0) + ' MB' : '--';
        updateMilestones(pct);
        updateWhatsHappening(s);
        updateRewardComponents(s);
        updateSmartAnalysis(s);
        updateIterationFeed(s);
        if (s.current_iteration > 0 && s.is_training) {
            chartData.labels.push(s.current_iteration);
            chartData.loss.push(s.current_loss);
            chartData.reward.push(s.current_reward);
            chartData.perplexity.push(s.perplexity || null);
            if (chartData.labels.length > 100) { chartData.labels.shift(); chartData.loss.shift(); chartData.reward.shift(); chartData.perplexity.shift(); }
            if (trainingChart) trainingChart.update();
        }
    } catch(e) {}
}

// === GENERATION ===
async function generateText() {
    var promptVal = document.getElementById('prompt').value.trim();
    if (!promptVal) { promptVal = document.getElementById('prompt').placeholder || 'Hello'; }
    const config = {
        model_name: document.getElementById('gen_model_name').value,
        prompt: promptVal,
        max_length: parseInt(document.getElementById('max_length').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        top_k: parseInt(document.getElementById('top_k').value)
    };
    document.getElementById('generated_output').innerHTML = '<span style="color:#888;">' + t('generating') + '</span>';
    try {
        const resp = await fetch('/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(config)});
        if (!resp.ok) { var err = await resp.text(); document.getElementById('generated_output').textContent = 'Error: ' + (resp.status === 500 ? JSON.parse(err).detail : err); return; }
        const data = await resp.json();
        if (data.token_details && data.token_details.length > 0) {
            document.getElementById('generated_output').innerHTML = data.token_details.map(function(t) {
                var hue = Math.round(t.confidence * 120);
                var bg = 'hsl(' + hue + ', 60%, 15%)';
                var border = 'hsl(' + hue + ', 60%, 35%)';
                var alts = t.top_alternatives ? t.top_alternatives.map(function(a) { return a.token + ' ' + (a.prob*100).toFixed(1) + '%'; }).join(', ') : '';
                return '<span class="token" style="background:' + bg + ';border:1px solid ' + border + ';" data-info="Confidence: ' + (t.confidence*100).toFixed(1) + '% | Alt: ' + alts + '">' + t.token + '</span>';
            }).join(' ');
        } else {
            document.getElementById('generated_output').textContent = data.generated_text || 'Error';
        }
        if (data.quality_metrics && data.quality_metrics.components) {
            renderRadar('qualityRadar', [data.quality_metrics], [t('radar_generation')]);
            document.getElementById('quality_radar_container').style.display = 'block';
        }
    } catch(e) { document.getElementById('generated_output').textContent = 'Error: ' + e.message; }
}

async function generateBeforeAfter() {
    var promptVal2 = document.getElementById('prompt').value.trim();
    if (!promptVal2) { promptVal2 = document.getElementById('prompt').placeholder || 'Hello'; }
    const config = {
        model_name: document.getElementById('gen_model_name').value,
        prompt: promptVal2,
        max_length: parseInt(document.getElementById('max_length').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        top_k: parseInt(document.getElementById('top_k').value)
    };
    document.getElementById('before_after_container').style.display = 'block';
    document.getElementById('before_text').textContent = t('loading');
    document.getElementById('after_text').textContent = t('loading');
    try {
        const resp = await fetch('/generate_before_after', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(config)});
        if (!resp.ok) { var err = await resp.text(); try { err = JSON.parse(err).detail; } catch(x) {} document.getElementById('before_text').textContent = 'Error: ' + err; return; }
        const data = await resp.json();
        document.getElementById('before_text').textContent = data.before ? data.before.text : 'N/A';
        document.getElementById('after_text').textContent = data.after ? data.after.text : 'N/A';
        document.getElementById('before_quality').textContent = 'Reward: ' + (data.before && data.before.quality ? data.before.quality.total.toFixed(4) : '0');
        document.getElementById('after_quality').textContent = 'Reward: ' + (data.after && data.after.quality ? data.after.quality.total.toFixed(4) : '0');
        if (data.improvement) {
            var summary = document.getElementById('improvement_summary');
            var delta = data.improvement.reward_delta;
            summary.style.display = 'block';
            summary.className = delta > 0 ? 'alert alert-success' : 'alert alert-info';
            var details = Object.entries(data.improvement.components_delta || {}).filter(function(e) { return Math.abs(e[1]) > 0.01; }).map(function(e) { return (REWARD_LABELS[e[0]] || e[0]) + ': ' + (e[1] > 0 ? '+' : '') + e[1].toFixed(3); }).join(', ');
            summary.textContent = delta > 0 ? t('improvement') + delta.toFixed(4) + '! ' + details : 'Reward: ' + delta.toFixed(4) + '. ' + details;
        }
    } catch(e) { document.getElementById('before_text').textContent = 'Error: ' + e.message; }
}

// === COMPARISON ===
async function loadCheckpoints() {
    var modelName = document.getElementById('compare_model_name').value;
    if (!modelName) return;
    try {
        var resp = await fetch('/checkpoints/' + modelName);
        if (!resp.ok) return;
        var data = await resp.json();
        var opts = data.checkpoints.map(function(c) { return '<option value="' + c.iteration + '">Iteration ' + c.iteration + ' (' + c.size_mb + ' MB)</option>'; }).join('');
        if (!opts) opts = '<option value="">(' + t('no_data') + ')</option>';
        ['checkpoint_a', 'checkpoint_b'].forEach(function(id) {
            document.getElementById(id).innerHTML = opts;
        });
    } catch(e) {}
}

async function compareCheckpoints() {
    var model = document.getElementById('compare_model_name').value;
    var iterA = parseInt(document.getElementById('checkpoint_a').value);
    var iterB = parseInt(document.getElementById('checkpoint_b').value);
    var prompt = document.getElementById('compare_prompt').value;
    if (!model || !prompt) return;
    document.getElementById('compare_results').style.display = 'block';
    document.getElementById('compare_text_a').textContent = t('generating');
    document.getElementById('compare_text_b').textContent = t('generating');
    try {
        var resp = await fetch('/compare_generations', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model_name: model, prompt: prompt, iterations: [iterA, iterB], max_length: 100})});
        if (!resp.ok) { var err = await resp.text(); try { err = JSON.parse(err).detail; } catch(x) {} document.getElementById('compare_text_a').textContent = 'Error: ' + err; return; }
        var data = await resp.json();
        if (data.comparisons && data.comparisons.length >= 2) {
            var a = data.comparisons[0], b = data.comparisons[1];
            document.getElementById('compare_label_a').textContent = 'Iteration ' + a.iteration;
            document.getElementById('compare_label_b').textContent = 'Iteration ' + b.iteration;
            document.getElementById('compare_text_a').textContent = a.text || a.error || 'N/A';
            document.getElementById('compare_text_b').textContent = b.text || b.error || 'N/A';
            document.getElementById('compare_quality_a').textContent = a.quality ? 'Reward: ' + a.quality.total.toFixed(4) : '';
            document.getElementById('compare_quality_b').textContent = b.quality ? 'Reward: ' + b.quality.total.toFixed(4) : '';
            if (a.quality && b.quality) {
                renderRadar('compareRadar', [a.quality, b.quality], ['Iter ' + a.iteration, 'Iter ' + b.iteration]);
                document.getElementById('compare_radar_container').style.display = 'block';
            }
        }
    } catch(e) { document.getElementById('compare_text_a').textContent = 'Error: ' + e.message; }
}

async function loadAnalyticsReports() {
    try {
        var resp = await fetch('/training_analytics/reports');
        var data = await resp.json();
        var div = document.getElementById('analytics_table');
        if (data.reports && data.reports.length > 0) {
            div.innerHTML = '<table><tr><th>Iter</th><th>Loss</th><th>Perplexity</th><th>Reward</th><th>Speed</th></tr>' +
                data.reports.map(function(r) { return '<tr><td>' + r.iteration + '</td><td>' + r.loss.toFixed(4) + '</td><td>' + r.perplexity.toFixed(1) + '</td><td>' + (r.reward && r.reward.total !== undefined ? r.reward.total.toFixed(4) : '--') + '</td><td>' + (r.tokens_per_sec ? r.tokens_per_sec.toFixed(0) + ' tok/s' : '--') + '</td></tr>'; }).join('') + '</table>';
        } else { div.innerHTML = '<p style="color:#888;">' + t('no_data') + '</p>'; }
    } catch(e) {}
}

// === RADAR ===
function renderRadar(canvasId, qualities, labels) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var existing = Chart.getChart(canvas);
    if (existing) existing.destroy();
    var colors = ['#667eea', '#10b981', '#f59e0b', '#ef4444'];
    var radarLabels = Object.keys(REWARD_LABELS).map(function(k) { return REWARD_LABELS[k]; });
    new Chart(canvas, {
        type: 'radar',
        data: {
            labels: radarLabels,
            datasets: qualities.map(function(q, i) { return {
                label: labels[i] || '#' + (i+1),
                data: Object.keys(REWARD_LABELS).map(function(k) { return q.components ? (q.components[k] || 0) : 0; }),
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '22',
                pointBackgroundColor: colors[i % colors.length]
            }; })
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { r: { min: 0, max: 1, grid: {color:'#333'}, angleLines: {color:'#333'}, pointLabels: {color:'#aaa', font:{size:10}}, ticks: {display:false} } },
            plugins: { legend: { labels: {color:'#aaa'} } }
        }
    });
}

// === MODELS ===
async function loadModelsList() {
    var resp = await fetch('/models');
    var data = await resp.json();
    var div = document.getElementById('models_list');
    div.innerHTML = data.models.map(function(m) {
        return '<div class="info-card"><h3>' + m.name + (m.trained ? ' <span style="color:#10b981;">(' + t('trained') + ')</span>' : '') + '</h3>'
            + '<p>d_model=' + m.config.d_model + ', layers=' + m.config.num_layers + ', heads=' + m.config.num_heads + ', vocab=' + m.config.vocab_size + '</p>'
            + '<p>' + t('datasets_count') + ': ' + (m.total_datasets || 0) + ' | ' + t('size') + ': ' + m.size_mb + ' MB</p>'
            + '<button class="btn btn-success" onclick="window.location.href=\'/download_model/' + m.name + '\'">' + t('btn_download') + '</button>'
            + '<button class="btn btn-danger" onclick="deleteModel(\'' + m.name + '\')">' + t('btn_delete') + '</button>'
            + '</div>';
    }).join('') || '<p style="color:#888;">' + t('no_models') + '</p>';
}

async function deleteModel(name) {
    if (!confirm(t('confirm_delete') + ' "' + name + '"?')) return;
    try {
        var resp = await fetch('/models/' + name, { method: 'DELETE' });
        var data = await resp.json();
        if (data.status === 'deleted') {
            loadModelsList();
            loadModelsSelect();
        }
    } catch(e) { alert('Error: ' + e.message); }
}

function handleModelFileSelect() {
    var input = document.getElementById('model_file_input');
    var nameInput = document.getElementById('upload_model_name');
    if (input.files.length) {
        var file = input.files[0];
        var sizeMB = (file.size / 1024 / 1024).toFixed(1);
        document.getElementById('model_file_name').textContent = file.name + ' (' + sizeMB + ' MB)';
        // Auto-fill model name from filename if empty
        if (!nameInput.value.trim()) {
            var baseName = file.name.replace(/\.(pt|pth|bin)$/i, '').replace(/[^a-zA-Z0-9_-]/g, '_');
            nameInput.value = baseName;
        }
    } else {
        document.getElementById('model_file_name').textContent = t('no_file_chosen');
    }
}

function uploadModel() {
    var name = document.getElementById('upload_model_name').value.trim();
    var input = document.getElementById('model_file_input');
    var statusDiv = document.getElementById('upload_model_status');
    if (!name) { statusDiv.innerHTML = '<div class="alert alert-error">' + t('enter_model_name') + '</div>'; return; }
    if (!input.files.length) { statusDiv.innerHTML = '<div class="alert alert-error">' + t('no_file_chosen') + '</div>'; return; }
    var file = input.files[0];
    var sizeMB = (file.size / 1024 / 1024).toFixed(1);
    statusDiv.innerHTML = '<div class="alert alert-info"><div style="margin-bottom:8px;">' + t('uploading_model') + ' (' + sizeMB + ' MB)...</div><div class="progress-bar"><div class="progress-fill" id="upload_progress" style="width:0%">0%</div></div></div>';
    var formData = new FormData();
    formData.append('file', file);
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload_model/' + encodeURIComponent(name));
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            var pct = Math.round(e.loaded / e.total * 100);
            var bar = document.getElementById('upload_progress');
            if (bar) { bar.style.width = pct + '%'; bar.textContent = pct + '%'; }
        }
    };
    xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300) {
            try {
                var data = JSON.parse(xhr.responseText);
                statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + (data.message || 'OK') + '</div>';
                loadModelsList();
                loadModelsSelect();
                input.value = '';
                document.getElementById('upload_model_name').value = '';
                document.getElementById('model_file_name').textContent = t('no_file_chosen');
            } catch(e) {
                statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + t('upload_complete') + '</div>';
                loadModelsList();
                loadModelsSelect();
            }
        } else {
            var errMsg = xhr.responseText;
            try { errMsg = JSON.parse(errMsg).detail; } catch(x) {}
            statusDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + errMsg + '</div>';
        }
    };
    xhr.onerror = function() {
        statusDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + t('upload_network_error') + '</div>';
    };
    xhr.send(formData);
}

function handleTokenizerSelect() {
    var input = document.getElementById('tokenizer_file_input');
    if (input.files.length) {
        var file = input.files[0];
        document.getElementById('tokenizer_file_name').textContent = file.name;
        // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ –∏–º—è –º–æ–¥–µ–ª–∏ —É–∫–∞–∑–∞–Ω–æ
        var name = document.getElementById('upload_model_name').value.trim();
        if (name) { uploadTokenizer(name, file); }
        else { document.getElementById('upload_model_status').innerHTML = '<div class="alert alert-info">' + t('tokenizer_enter_name') + '</div>'; }
    }
}

async function uploadTokenizer(modelName, file) {
    var statusDiv = document.getElementById('upload_model_status');
    statusDiv.innerHTML = '<div class="alert alert-info">' + t('uploading_tokenizer') + '</div>';
    var formData = new FormData();
    formData.append('file', file);
    try {
        var resp = await fetch('/upload_tokenizer/' + encodeURIComponent(modelName), { method: 'POST', body: formData });
        if (!resp.ok) { var err = await resp.text(); try { err = JSON.parse(err).detail; } catch(x) {} statusDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + err + '</div>'; return; }
        var data = await resp.json();
        statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ ' + (data.message || 'OK') + '</div>';
        document.getElementById('tokenizer_file_input').value = '';
        document.getElementById('tokenizer_file_name').textContent = '';
    } catch(e) { statusDiv.innerHTML = '<div class="alert alert-error">‚ùå ' + e.message + '</div>'; }
}

// === WIZARD ===
async function checkWizard() {
    try {
        var resp = await fetch('/models');
        var data = await resp.json();
        if (data.models.length === 0) document.getElementById('wizard_modal').classList.add('active');
    } catch(e) {}
}
function wizardSelectPreset(name) {
    closeWizard();
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    document.querySelectorAll('.tab')[2].classList.add('active');
    document.getElementById('create').classList.add('active');
    applyPreset(name);
}
function closeWizard() { document.getElementById('wizard_modal').classList.remove('active'); }

// === LANGUAGE TOGGLE ===
var currentLang = localStorage.getItem('azr_lang') || 'ru';
var TRANSLATIONS = {
    ru: {
        subtitle: '–°–æ–∑–¥–∞–≤–∞–π—Ç–µ, –æ–±—É—á–∞–π—Ç–µ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∏ –Ω–∞–≥–ª—è–¥–Ω–æ',
        tab_help: '–ü–æ–º–æ—â—å', tab_catalog: '–ö–∞—Ç–∞–ª–æ–≥', tab_create: '–°–æ–∑–¥–∞—Ç—å',
        tab_datasets: '–î–∞—Ç–∞—Å–µ—Ç—ã', tab_train: '–û–±—É—á–µ–Ω–∏–µ', tab_generate: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è',
        tab_compare: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ', tab_models: '–ú–æ–¥–µ–ª–∏',
        quick_start: '–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç',
        three_steps: '3 —à–∞–≥–∞ –¥–æ –ø–µ—Ä–≤–æ–π –Ω–µ–π—Ä–æ—Å–µ—Ç–∏',
        step1: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç–∞—Å–µ—Ç ‚Äî –í–∫–ª–∞–¥–∫–∞ "–ö–∞—Ç–∞–ª–æ–≥" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–∏–≥—É –∏–ª–∏ —Ç–µ–∫—Å—Ç –∏ —Å–∫–∞—á–∞–π—Ç–µ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º',
        step2: '–°–æ–∑–¥–∞–π—Ç–µ –º–æ–¥–µ–ª—å ‚Äî –í–∫–ª–∞–¥–∫–∞ "–°–æ–∑–¥–∞—Ç—å" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É',
        step3: '–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ ‚Äî –í–∫–ª–∞–¥–∫–∞ "–û–±—É—á–µ–Ω–∏–µ" ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å"',
        after_training_tip: '–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è" –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ"',
        whats_new: '–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ v2',
        new_catalog: '–ö–∞—Ç–∞–ª–æ–≥ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ ‚Äî 25+ –∫–Ω–∏–≥ –∏ —Ç–µ–∫—Å—Ç–æ–≤ + –ø–æ–∏—Å–∫ –ø–æ HuggingFace',
        new_reinforce: 'REINFORCE ‚Äî –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è –Ω–∞ —Å–≤–æ–∏—Ö –æ—à–∏–±–∫–∞—Ö (policy gradient)',
        new_metrics: '6 –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ ‚Äî diversity, coherence, repetition, length, vocabulary, naturalness',
        new_analytics: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –ø–µ—Ä–ø–ª–µ–∫—Å–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å, ETA, –±–µ–Ω—á–º–∞—Ä–∫–∏',
        new_compare: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ ‚Äî –∫–∞–∫ –º–æ–¥–µ–ª—å —É–ª—É—á—à–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–∏—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö',
        new_confidence: 'Confidence ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –≤ –∫–∞–∂–¥–æ–º —Å–ª–æ–≤–µ',
        new_before_after: '–î–æ/–ü–æ—Å–ª–µ ‚Äî –Ω–µ–æ–±—É—á–µ–Ω–Ω–∞—è vs –æ–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å',
        configurations: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏',
        th_goal: '–¶–µ–ª—å', th_time: '–í—Ä–µ–º—è',
        time_5min: '~5 –º–∏–Ω', time_2h: '~2 —á–∞—Å–∞', time_24h: '~24 —á–∞—Å–∞',
        faq_loss: 'Loss –Ω–µ –ø–∞–¥–∞–µ—Ç? ‚Äî –£–º–µ–Ω—å—à–∏—Ç–µ learning rate –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –º–æ–¥–µ–ª—å.',
        faq_repeat: '–ü–æ–≤—Ç–æ—Ä—è–µ—Ç –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç? ‚Äî Overfitting. –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –º–µ–Ω—å—à–µ –∏—Ç–µ—Ä–∞—Ü–∏–π.',
        faq_memory: 'Out of memory? ‚Äî –£–º–µ–Ω—å—à–∏—Ç–µ batch_size –∏–ª–∏ d_model.',
        faq_continue: '–ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? ‚Äî Stop, –ø–æ—Ç–æ–º –∑–∞–Ω–æ–≤–æ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —á–µ–∫–ø–æ–∏–Ω—Ç–∞.',
        catalog_title: '–ö–∞—Ç–∞–ª–æ–≥ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤',
        catalog_desc: '–°–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º –∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –Ω–∞ HuggingFace',
        btn_search_hf: '–ü–æ–∏—Å–∫ HF',
        btn_add_url: '+ URL',
        hf_placeholder: '–ü–æ–∏—Å–∫ –Ω–∞ HuggingFace (–Ω–∞–ø—Ä–∏–º–µ—Ä: russian text, poetry, code)...',
        prompt_placeholder: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç —ç—Ç–æ...',
        choose_preset: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç',
        preset_quick: '–ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç', preset_standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', preset_quality: '–ö–∞—á–µ—Å—Ç–≤–æ',
        preset_quick_desc: '~5 –º–∏–Ω—É—Ç, –±–∞–∑–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ',
        preset_quick_specs: '128d / 4 —Å–ª–æ—è / 1K –∏—Ç–µ—Ä',
        preset_standard_desc: '~2 —á–∞—Å–∞, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ',
        preset_standard_specs: '256d / 6 —Å–ª–æ—ë–≤ / 10K –∏—Ç–µ—Ä',
        preset_quality_desc: '~24 —á–∞—Å–∞, –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
        preset_quality_specs: '512d / 12 —Å–ª–æ—ë–≤ / 100K –∏—Ç–µ—Ä',
        model_name: '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏:',
        tip_vocab: '–†–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è. 10000-25000 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ.',
        tip_dmodel: '–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏. –ë–æ–ª—å—à–µ = —É–º–Ω–µ–µ –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.',
        tip_layers: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä-–±–ª–æ–∫–æ–≤. 4-12 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ.',
        tip_heads: 'Attention heads. –î–æ–ª–∂–Ω–æ –¥–µ–ª–∏—Ç—å d_model –Ω–∞—Ü–µ–ª–æ.',
        tip_iterations: '1000=5–º–∏–Ω, 10000=2—á, 100000=24—á',
        tip_temperature: '0.5=–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ, 1.0=–Ω–æ—Ä–º–∞, 1.5+=–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ',
        btn_create_model: '–°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å',
        manage_datasets: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞–º–∏',
        upload_files: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã',
        supported_formats: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .txt, .csv, .json, .jsonl, .pdf, .jpg, .png',
        manage: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
        select_model: '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:',
        attached_datasets: '–ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫ –º–æ–¥–µ–ª–∏:',
        available_datasets: '–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç–∞—Å–µ—Ç—ã:',
        training_title: '–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏',
        btn_start_training: '–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ',
        btn_stop_training: '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
        ms_start: '–°—Ç–∞—Ä—Ç', ms_warmup: '–†–∞–∑–æ–≥—Ä–µ–≤', ms_quarter: '–ß–µ—Ç–≤–µ—Ä—Ç—å',
        ms_half: '–ü–æ–ª–æ–≤–∏–Ω–∞', ms_almost: '–ü–æ—á—Ç–∏', ms_done: '–ì–æ—Ç–æ–≤–æ',
        whats_happening: '–ß—Ç–æ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç',
        status_training: '–°—Ç–∞—Ç—É—Å –æ–±—É—á–µ–Ω–∏—è',
        status_label: '–°—Ç–∞—Ç—É—Å:', iteration_label: '–ò—Ç–µ—Ä–∞—Ü–∏—è:',
        loss_label: 'Loss:', reward_label: 'Reward:', perplexity_label: 'Perplexity:',
        speed_label: '–°–∫–æ—Ä–æ—Å—Ç—å:', remaining_label: '–û—Å—Ç–∞–ª–æ—Å—å:', memory_label: '–ü–∞–º—è—Ç—å:',
        training_idle: '–ù–µ –∞–∫—Ç–∏–≤–Ω–æ', training_active: '–û–±—É—á–∞–µ—Ç—Å—è...',
        reward_components: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞–≥—Ä–∞–¥—ã',
        smart_analysis_title: 'üß† –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å',
        iteration_feed_title: 'üìç –ñ–∏–≤–∞—è –ª–µ–Ω—Ç–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π',
        generation_title: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞',
        generate_prompt: '–ü—Ä–æ–º–ø—Ç:',
        btn_generate: '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å',
        before_after: '–î–æ / –ü–æ—Å–ª–µ',
        generation_result: '–†–µ–∑—É–ª—å—Ç–∞—Ç',
        confidence_hint: '(—Ü–≤–µ—Ç = —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: –∑–µ–ª—ë–Ω—ã–π=–≤—ã—Å–æ–∫–∞—è, –∂—ë–ª—Ç—ã–π=—Å—Ä–µ–¥–Ω—è—è, –∫—Ä–∞—Å–Ω—ã–π=–Ω–∏–∑–∫–∞—è)',
        text_placeholder: '–¢–µ–∫—Å—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...',
        quality_metrics: '–ö–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏',
        before_vs_after: '–î–æ –æ–±—É—á–µ–Ω–∏—è vs –ü–æ—Å–ª–µ',
        before_training: '–î–æ –æ–±—É—á–µ–Ω–∏—è', after_training: '–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è',
        compare_checkpoints: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏—Ç–µ—Ä–∞—Ü–∏–π',
        btn_compare: '–°—Ä–∞–≤–Ω–∏—Ç—å',
        compare_quality: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞',
        iteration_history: '–ò—Å—Ç–æ—Ä–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π',
        btn_load_reports: '–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á—ë—Ç—ã',
        my_models: '–ú–æ–∏ –º–æ–¥–µ–ª–∏',
        btn_refresh: '–û–±–Ω–æ–≤–∏—Ç—å',
        btn_download: '–°–∫–∞—á–∞—Ç—å',
        btn_delete: '–£–¥–∞–ª–∏—Ç—å',
        trained: '–û–±—É—á–µ–Ω–∞',
        datasets_count: '–î–∞—Ç–∞—Å–µ—Ç–æ–≤',
        size: '–†–∞–∑–º–µ—Ä',
        confirm_delete: '–£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ–ª—å',
        no_models: '–ù–µ—Ç –º–æ–¥–µ–ª–µ–π.',
        fill_name_url: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ URL',
        wizard_welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
        wizard_desc: '–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –Ω–µ–π—Ä–æ—Å–µ—Ç—å –∑–∞ 3 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞.',
        btn_skip: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',
        preview: '–ü—Ä–µ–≤—å—é',
        btn_close: '–ó–∞–∫—Ä—ã—Ç—å',
        hw_recommendation: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è',
        hw_gpu_large: 'GPU {name} ({mem} GB) ‚Äî –º–æ–∂–Ω–æ –æ–±—É—á–∞—Ç—å –±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏',
        hw_gpu_standard: 'GPU {name} ({mem} GB) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏',
        hw_gpu_small: 'GPU —Å {mem} GB ‚Äî —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–µ –º–æ–¥–µ–ª–∏',
        hw_cpu_standard: '{mem} GB RAM, CPU ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–º–µ–¥–ª–µ–Ω–Ω–æ)',
        hw_cpu_quick: '{mem} GB RAM, CPU ‚Äî —Ç–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã',
        btn_delete_ds: '–£–¥–∞–ª–∏—Ç—å',
        confirm_delete_ds: '–£–¥–∞–ª–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç "{name}"? –û–Ω –±—É–¥–µ—Ç –æ—Ç–∫—Ä–µ–ø–ª—ë–Ω –æ—Ç –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π.',
        btn_resume_training: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        live_generation: 'üîÆ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏',
        upload_model_title: '–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å',
        upload_model_hint: '–ó–∞–≥—Ä—É–∑–∏—Ç–µ .pt —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏ (state_dict –∏–ª–∏ –ø–æ–ª–Ω—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç)',
        btn_upload_model: '–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å',
        uploading_model: '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏',
        upload_complete: '–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ',
        upload_network_error: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ',
        btn_upload_tokenizer: '+ –¢–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä (.pkl)',
        uploading_tokenizer: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞...',
        tokenizer_enter_name: '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä',
        status_idle: '–ù–µ –∑–∞–ø—É—â–µ–Ω–æ',
        checkpoint_a_label: '–ß–µ–∫–ø–æ–∏–Ω—Ç A:',
        checkpoint_b_label: '–ß–µ–∫–ø–æ–∏–Ω—Ç B:',
        compare_prompt_label: '–ü—Ä–æ–º–ø—Ç:',
        compare_default_prompt: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç',
        placeholder_name: '–ù–∞–∑–≤–∞–Ω–∏–µ',
        uploaded: '–ó–∞–≥—Ä—É–∂–µ–Ω–æ',
        btn_choose_file: '–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª',
        no_file_chosen: '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω',
        radar_generation: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è',
        eta_sec: '—Å–µ–∫', eta_min: '–º–∏–Ω', eta_h: '—á', eta_m: '–º',
        btn_attach: '+ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å', btn_detach: '–û—Ç–∫—Ä–µ–ø–∏—Ç—å',
        filter_all: '–í—Å–µ',
        no_datasets: '–ù–µ—Ç –¥–∞—Ç–∞—Å–µ—Ç–æ–≤.', no_attached: '–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö.',
        downloading: '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...',
        already_downloaded: '–£–∂–µ —Å–∫–∞—á–∞–Ω',
        btn_download_ds: '–°–∫–∞—á–∞—Ç—å', btn_preview: '–ü—Ä–µ–≤—å—é',
        searching: '–ü–æ–∏—Å–∫...', nothing_found: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.',
        no_data: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.',
        model_created: '–ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞! –ü–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: ',
        enter_model_name: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏',
        generating: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        improvement: '–£–ª—É—á—à–µ–Ω–∏–µ reward –Ω–∞ ',
        wh_start: '–ú–æ–¥–µ–ª—å —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç. Loss –≤—ã—Å–æ–∫–∏–π ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ò–¥—ë—Ç –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.',
        wh_early: '–ú–æ–¥–µ–ª—å –∏–∑—É—á–∞–µ—Ç —á–∞—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –∏ –ø—Ä–æ—Å—Ç—ã–µ —Å–æ—á–µ—Ç–∞–Ω–∏—è.',
        wh_mid: '–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤—ã—É—á–µ–Ω—ã. Reward —Ä–∞—Å—Ç—ë—Ç ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ª—É—á—à–∞–µ—Ç—Å—è.',
        wh_late: '–û–±—É—á–µ–Ω–∏–µ –∏–¥—ë—Ç. –ú–æ–¥–µ–ª—å —É–ª–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–æ–Ω–∫–∏–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏. Loss –ø–∞–¥–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.',
        wh_final: '–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è! –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏. –°–∫–æ—Ä–æ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.',
        wh_done: '–û–±—É—á–µ–Ω–∏–µ –ø–æ—á—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!',
        rl_diversity: '–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ', rl_coherence: '–ö–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å', rl_repetition: '–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤',
        rl_length: '–î–ª–∏–Ω–∞', rl_vocabulary: '–°–ª–æ–≤–∞—Ä—å', rl_naturalness: '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å',
        iter_label: '–ò—Ç–µ—Ä–∞—Ü–∏—è', speed_short: '–°–∫–æ—Ä–æ—Å—Ç—å',
        an_loss_down: 'Loss —É–ø–∞–ª –Ω–∞ {n}% ‚Äî –º–æ–¥–µ–ª—å —É—á–∏—Ç—Å—è',
        an_loss_up: 'Loss –≤—ã—Ä–æ—Å –Ω–∞ {n}% ‚Äî –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è',
        an_loss_stable: 'Loss —Å—Ç–∞–±–∏–ª–µ–Ω ({n}) ‚Äî –º–æ–¥–µ–ª—å –≤ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏–∏',
        an_rew_up: 'Reward –≤—ã—Ä–æ—Å –Ω–∞ {n}% ‚Äî —Ç–µ–∫—Å—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ª—É—á—à–µ',
        an_rew_down: 'Reward —É–ø–∞–ª –Ω–∞ {n}% ‚Äî —Å–ª–µ–¥–∏ –∑–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏',
        an_rew_stable: 'Reward —Å—Ç–∞–±–∏–ª–µ–Ω ({n})',
        an_overfit_hi: 'Val Loss ({v}) > Train Loss ({t}) ‚Äî —Ä–∏—Å–∫ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è! –°—Ç–æ–ø —Å–∫–æ—Ä–æ.',
        an_overfit_mid: 'Val Loss –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ Train Loss ‚Äî –Ω–µ–±–æ–ª—å—à–æ–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ, –Ω–æ—Ä–º–∞',
        an_overfit_ok: 'Val Loss –∏ Train Loss –±–ª–∏–∑–∫–∏ ‚Äî –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è –Ω–µ—Ç',
        an_device: '{dev} ‚Äî {n} —Ç–æ–∫–µ–Ω–æ–≤/—Å–µ–∫',
        an_weak: '–°–ª–∞–±–æ–µ –º–µ—Å—Ç–æ: {comp} ({n}) ‚Äî –Ω–∞–¥ —ç—Ç–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç REINFORCE',
        an_best: '–õ—É—á—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å: {comp} ({n})',
        gpu_checking: '–ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...',
        gpu_installing: '‚è≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É GPU...',
        gpu_installed: '‚úÖ GPU —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫',
        gpu_error: '‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ GPU',
        gpu_cpu_mode: 'üê¢ CPU —Ä–µ–∂–∏–º (–æ–±—É—á–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–æ–µ)',
        gpu_activate: '‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å GPU',
        gpu_retry: 'üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞',
        gpu_restart_msg: '‚úÖ GPU —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.',
        gpu_downloading: '‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º (~2 –ì–ë)...',
        gpu_venv_hint: 'GPU —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –ó–∞–ø—É—Å—Ç–∏ start_gpu.bat –¥–ª—è GPU-—Ä–µ–∂–∏–º–∞. –ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–π –Ω–∞ CPU.',
    },
    en: {
        subtitle: 'Create, train and analyze neural networks ‚Äî simple and visual',
        tab_help: 'Help', tab_catalog: 'Catalog', tab_create: 'Create',
        tab_datasets: 'Datasets', tab_train: 'Training', tab_generate: 'Generate',
        tab_compare: 'Compare', tab_models: 'Models',
        quick_start: 'Quick Start',
        three_steps: '3 steps to your first neural network',
        step1: 'Choose a dataset ‚Äî "Catalog" tab ‚Äî pick a book or text and download with one click',
        step2: 'Create a model ‚Äî "Create" tab ‚Äî choose a preset and click the button',
        step3: 'Start training ‚Äî "Training" tab ‚Äî select a model, press "Start"',
        after_training_tip: 'After training ‚Äî generate text on the "Generate" tab and compare iterations on the "Compare" tab',
        whats_new: 'What\'s new in v2',
        new_catalog: 'Dataset Catalog ‚Äî 25+ books and texts + HuggingFace search',
        new_reinforce: 'REINFORCE ‚Äî model learns from its mistakes (policy gradient)',
        new_metrics: '6 quality metrics ‚Äî diversity, coherence, repetition, length, vocabulary, naturalness',
        new_analytics: 'Analytics ‚Äî perplexity, speed, ETA, benchmarks',
        new_compare: 'Comparison ‚Äî how the model improves on the same prompts',
        new_confidence: 'Confidence ‚Äî model certainty for each word',
        new_before_after: 'Before/After ‚Äî untrained vs trained model',
        configurations: 'Configurations',
        th_goal: 'Goal', th_time: 'Time',
        time_5min: '~5 min', time_2h: '~2 hours', time_24h: '~24 hours',
        faq_loss: 'Loss not decreasing? ‚Äî Reduce learning rate or increase model size.',
        faq_repeat: 'Repeating same text? ‚Äî Overfitting. More data or fewer iterations.',
        faq_memory: 'Out of memory? ‚Äî Reduce batch_size or d_model.',
        faq_continue: 'How to continue? ‚Äî Stop, then restart ‚Äî it will resume from checkpoint.',
        catalog_title: 'Dataset Catalog',
        catalog_desc: 'Download ready-made datasets with one click or find them on HuggingFace',
        btn_search_hf: 'Search HF',
        btn_add_url: '+ URL',
        hf_placeholder: 'Search HuggingFace (e.g.: russian text, poetry, code)...',
        prompt_placeholder: 'Artificial intelligence is...',
        choose_preset: 'Choose a preset',
        preset_quick: 'Quick Test', preset_standard: 'Standard', preset_quality: 'Quality',
        preset_quick_desc: '~5 minutes, basic quality',
        preset_quick_specs: '128d / 4 layers / 1K iter',
        preset_standard_desc: '~2 hours, good quality',
        preset_standard_specs: '256d / 6 layers / 10K iter',
        preset_quality_desc: '~24 hours, best results',
        preset_quality_specs: '512d / 12 layers / 100K iter',
        model_name: 'Model name:',
        tip_vocab: 'Vocabulary size. 10000-25000 is optimal.',
        tip_dmodel: 'Model dimension. Larger = smarter but slower.',
        tip_layers: 'Number of transformer blocks. 4-12 is optimal.',
        tip_heads: 'Attention heads. Must evenly divide d_model.',
        tip_iterations: '1000=5min, 10000=2h, 100000=24h',
        tip_temperature: '0.5=conservative, 1.0=normal, 1.5+=creative',
        btn_create_model: 'Create Model',
        manage_datasets: 'Manage Datasets',
        upload_files: 'Upload Files',
        supported_formats: 'Supported: .txt, .csv, .json, .jsonl, .pdf, .jpg, .png',
        manage: 'Management',
        select_model: 'Select model:',
        attached_datasets: 'Attached to model:',
        available_datasets: 'Available datasets:',
        training_title: 'Model Training',
        btn_start_training: 'Start Training',
        btn_stop_training: 'Stop',
        ms_start: 'Start', ms_warmup: 'Warmup', ms_quarter: 'Quarter',
        ms_half: 'Half', ms_almost: 'Almost', ms_done: 'Done',
        whats_happening: 'What\'s happening now',
        status_training: 'Training Status',
        status_label: 'Status:', iteration_label: 'Iteration:',
        loss_label: 'Loss:', reward_label: 'Reward:', perplexity_label: 'Perplexity:',
        speed_label: 'Speed:', remaining_label: 'Remaining:', memory_label: 'Memory:',
        training_idle: 'Idle', training_active: 'Training...',
        reward_components: 'Reward Components',
        smart_analysis_title: 'üß† What Changed',
        iteration_feed_title: 'üìç Live Iteration Feed',
        generation_title: 'Text Generation',
        generate_prompt: 'Prompt:',
        btn_generate: 'Generate',
        before_after: 'Before / After',
        generation_result: 'Result',
        confidence_hint: '(color = model confidence: green=high, yellow=medium, red=low)',
        text_placeholder: 'Text will appear here...',
        quality_metrics: 'Generation Quality',
        before_vs_after: 'Before Training vs After',
        before_training: 'Before Training', after_training: 'After Training',
        compare_checkpoints: 'Compare Iterations',
        btn_compare: 'Compare',
        compare_quality: 'Quality Comparison',
        iteration_history: 'Iteration History',
        btn_load_reports: 'Load Reports',
        my_models: 'My Models',
        btn_refresh: 'Refresh',
        btn_download: 'Download',
        btn_delete: 'Delete',
        trained: 'Trained',
        datasets_count: 'Datasets',
        size: 'Size',
        confirm_delete: 'Delete model',
        no_models: 'No models.',
        fill_name_url: 'Enter name and URL',
        wizard_welcome: 'Welcome!',
        wizard_desc: 'Create your first neural network in 3 simple steps.',
        btn_skip: 'Skip',
        preview: 'Preview',
        btn_close: 'Close',
        hw_recommendation: 'Recommendation',
        hw_gpu_large: 'GPU {name} ({mem} GB) ‚Äî can train large models',
        hw_gpu_standard: 'GPU {name} ({mem} GB) ‚Äî standard models',
        hw_gpu_small: 'GPU with {mem} GB ‚Äî small models only',
        hw_cpu_standard: '{mem} GB RAM, CPU ‚Äî standard models (slow)',
        hw_cpu_quick: '{mem} GB RAM, CPU ‚Äî quick tests only',
        btn_delete_ds: 'Delete',
        confirm_delete_ds: 'Delete dataset "{name}"? It will be detached from all models.',
        btn_resume_training: 'Resume',
        live_generation: 'üîÆ Live Generation',
        upload_model_title: 'Upload Model',
        upload_model_hint: 'Upload a .pt model file (state_dict or full checkpoint)',
        btn_upload_model: 'Upload Model',
        uploading_model: 'Uploading model',
        upload_complete: 'Model uploaded successfully',
        upload_network_error: 'Network error during upload',
        btn_upload_tokenizer: '+ Tokenizer (.pkl)',
        uploading_tokenizer: 'Uploading tokenizer...',
        tokenizer_enter_name: 'Enter model name first, then upload tokenizer',
        status_idle: 'Not running',
        checkpoint_a_label: 'Checkpoint A:',
        checkpoint_b_label: 'Checkpoint B:',
        compare_prompt_label: 'Prompt:',
        compare_default_prompt: 'Artificial intelligence',
        placeholder_name: 'Name',
        uploaded: 'Uploaded',
        btn_choose_file: 'Choose file',
        no_file_chosen: 'No file chosen',
        radar_generation: 'Generation',
        eta_sec: 's', eta_min: 'min', eta_h: 'h', eta_m: 'm',
        btn_attach: '+ Attach', btn_detach: 'Detach',
        filter_all: 'All',
        no_datasets: 'No datasets.', no_attached: 'No attached datasets.',
        downloading: 'Downloading...',
        already_downloaded: 'Downloaded',
        btn_download_ds: 'Download', btn_preview: 'Preview',
        searching: 'Searching...', nothing_found: 'Nothing found.',
        no_data: 'No data.',
        model_created: 'Model created! Parameters: ',
        enter_model_name: 'Enter model name',
        generating: 'Generating...',
        loading: 'Loading...',
        improvement: 'Reward improved by ',
        wh_start: 'Model is just starting. High loss is normal. Learning basic patterns.',
        wh_early: 'Model is learning frequent words and simple combinations.',
        wh_mid: 'Basic patterns learned. Reward is growing ‚Äî generation quality improves.',
        wh_late: 'Training in progress. Model is catching subtle patterns. Loss decreasing slower is normal.',
        wh_final: 'Final stage! Last adjustments. Training will finish soon.',
        wh_done: 'Training is almost complete!',
        rl_diversity: 'Diversity', rl_coherence: 'Coherence', rl_repetition: 'No Repetition',
        rl_length: 'Length', rl_vocabulary: 'Vocabulary', rl_naturalness: 'Naturalness',
        iter_label: 'Iteration', speed_short: 'Speed',
        an_loss_down: 'Loss fell {n}% ‚Äî model is learning',
        an_loss_up: 'Loss rose {n}% ‚Äî training instability',
        an_loss_stable: 'Loss stable ({n}) ‚Äî equilibrium',
        an_rew_up: 'Reward up {n}% ‚Äî quality improving',
        an_rew_down: 'Reward down {n}% ‚Äî check components',
        an_rew_stable: 'Reward stable ({n})',
        an_overfit_hi: 'Val Loss ({v}) > Train Loss ({t}) ‚Äî overfitting risk! Stop soon.',
        an_overfit_mid: 'Val Loss slightly above Train Loss ‚Äî minor overfitting, normal',
        an_overfit_ok: 'Val Loss and Train Loss close ‚Äî no overfitting',
        an_device: '{dev} ‚Äî {n} tokens/sec',
        an_weak: 'Weak point: {comp} ({n}) ‚Äî REINFORCE is working on it',
        an_best: 'Best metric: {comp} ({n})',
        gpu_checking: 'Checking device...',
        gpu_installing: '‚è≥ Installing GPU support...',
        gpu_installed: '‚úÖ GPU installed ‚Äî restart required',
        gpu_error: '‚ùå GPU installation error',
        gpu_cpu_mode: 'üê¢ CPU mode (slow training)',
        gpu_activate: '‚ö° Activate GPU',
        gpu_retry: 'üîÑ Retry',
        gpu_restart_msg: '‚úÖ GPU installed! Restart the server and refresh the page.',
        gpu_downloading: '‚¨áÔ∏è Downloading (~2 GB)...',
        gpu_venv_hint: 'GPU already installed! Run start_gpu.bat for GPU mode. Or continue on CPU.',
    }
};

function switchLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('azr_lang', lang);
    document.getElementById('lang_ru').classList.toggle('active', lang === 'ru');
    document.getElementById('lang_en').classList.toggle('active', lang === 'en');
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
            el.textContent = TRANSLATIONS[lang][key];
        }
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-placeholder');
        if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
            el.placeholder = TRANSLATIONS[lang][key];
        }
    });
    document.querySelectorAll('[data-i18n-value]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-value');
        if (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) {
            el.value = TRANSLATIONS[lang][key];
        }
    });
    // Update dynamic content using t()
    REWARD_LABELS = getRewardLabels();
    // Re-render dynamic tabs that use t() and currentLang
    if (typeof currentCategory !== 'undefined') loadCatalog(currentCategory);
    loadHWRecommendation();
    loadDatasets();
    checkGPUStatus();
}

function t(key) {
    return (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) || key;
}

// ‚îÄ‚îÄ GPU —Å—Ç–∞—Ç—É—Å-–±–∞—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkGPUStatus() {
    try {
        const r = await fetch('/gpu_status');
        const d = await r.json();
        const dot         = document.getElementById('gpu-dot');
        const label       = document.getElementById('gpu-label');
        const installArea = document.getElementById('gpu-install-area');
        const restartNote = document.getElementById('gpu-restart-notice');
        const installBtn  = document.getElementById('gpu-install-btn');
        const prog        = document.getElementById('gpu-install-progress');
        const fill        = document.getElementById('gpu-progress-fill');
        const msg         = document.getElementById('gpu-install-msg');
        const s           = d.install_status || {};

        if (d.cuda_available) {
            // GPU –∞–∫—Ç–∏–≤–µ–Ω
            dot.style.background = '#10b981';
            label.style.color = '#10b981';
            label.textContent = 'üöÄ GPU: ' + (d.gpu_name || 'CUDA');
            installArea.style.display = 'none';
            restartNote.style.display = 'none';

        } else if (s.is_installing) {
            // –ò–¥—ë—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∞
            dot.style.background = '#f59e0b';
            label.style.color = '#f59e0b';
            label.textContent = t('gpu_installing');
            installArea.style.display = 'flex';
            prog.style.display = 'block';
            installBtn.style.display = 'none';
            restartNote.style.display = 'none';
            const pct = Math.max(0, s.progress || 0);
            const isDownloading = (pct >= 30 && pct <= 84);
            if (isDownloading) {
                const wave = Math.floor(Date.now() / 1200) % 20;
                fill.style.width = Math.min(84, pct + wave) + '%';
                fill.textContent = t('gpu_downloading');
            } else {
                fill.style.width = pct + '%';
                fill.textContent = pct + '%';
            }
            fill.style.background = '';
            msg.innerHTML = (s.message || '').replace(/\n/g, '<br>');
            msg.style.color = '#aaa';

        } else if (s.progress === -1 || (s.error && s.error !== '')) {
            // –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            dot.style.background = '#ef4444';
            label.style.color = '#ef4444';
            label.textContent = t('gpu_error');
            installArea.style.display = 'flex';
            prog.style.display = 'block';
            restartNote.style.display = 'none';
            fill.style.width = '0%';
            fill.style.background = '';
            fill.textContent = '';
            msg.innerHTML = (s.message || s.error || '').replace(/\n/g, '<br>');
            msg.style.color = '#ef4444';
            installBtn.style.display = '';
            installBtn.disabled = false;
            installBtn.textContent = t('gpu_retry');

        } else if (s.success) {
            // –¢–æ–ª—å–∫–æ —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ (—Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è) ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
            dot.style.background = '#10b981';
            label.style.color = '#10b981';
            label.textContent = t('gpu_installed');
            installArea.style.display = 'flex';
            prog.style.display = 'block';
            fill.style.width = '100%';
            fill.style.background = '#10b981';
            fill.textContent = '100%';
            msg.style.color = '#10b981';
            msg.innerHTML = t('gpu_restart_msg');
            installBtn.style.display = 'none';
            restartNote.style.display = 'none';

        } else if (d.venv_gpu_ready) {
            // –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, –Ω–æ GPU-venv —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí CPU + –ø–æ–¥—Å–∫–∞–∑–∫–∞
            const pyVer = d.python_version || '';
            dot.style.background = '#f59e0b';
            label.style.color = '#f59e0b';
            label.textContent = t('gpu_cpu_mode') + (pyVer ? ' (Python ' + pyVer + ')' : '');
            installArea.style.display = 'flex';
            prog.style.display = 'block';
            fill.parentElement.style.display = 'none';  // —Å–∫—Ä—ã—Ç—å progress-bar
            msg.style.color = '#10b981';
            msg.innerHTML = 'üí° ' + t('gpu_venv_hint');
            installBtn.style.display = '';
            installBtn.disabled = false;
            installBtn.textContent = t('gpu_activate');
            restartNote.style.display = 'none';

        } else {
            // –ß–∏—Å—Ç—ã–π CPU —Ä–µ–∂–∏–º ‚Äî GPU –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
            const pyVer = d.python_version || '';
            dot.style.background = '#ef4444';
            label.style.color = '#ef4444';
            label.textContent = t('gpu_cpu_mode') + (pyVer ? ' (Python ' + pyVer + ')' : '');
            installArea.style.display = 'flex';
            prog.style.display = 'none';
            msg.textContent = '';
            msg.style.color = '';
            installBtn.style.display = '';
            installBtn.disabled = false;
            installBtn.textContent = t('gpu_activate');
            restartNote.style.display = 'none';
        }
    } catch(e) { /* —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª */ }
}

async function installGPU() {
    const btn = document.getElementById('gpu-install-btn');
    btn.disabled = true;
    btn.textContent = '‚è≥...';
    try {
        const r = await fetch('/gpu_install', {method:'POST'});
        const d = await r.json();
        if (d.status === 'already_available') {
            await checkGPUStatus();
        } else if (d.status === 'installing') {
            document.getElementById('gpu-install-progress').style.display = 'block';
            btn.style.display = 'none';
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            const interval = setInterval(async () => {
                try {
                    const r2 = await fetch('/gpu_status');
                    const d2 = await r2.json();
                    await checkGPUStatus();
                    if (!d2.install_status.is_installing) clearInterval(interval);
                } catch(e) { clearInterval(interval); await checkGPUStatus(); }
            }, 2000);
        } else {
            // already_installing –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å
            await checkGPUStatus();
        }
    } catch(e) {
        btn.disabled = false;
        btn.textContent = t('gpu_activate');
    }
}
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

window.addEventListener('load', function() {
    loadModelsSelect();
    initChart();
    startStatusUpdates();
    checkWizard();
    checkGPUStatus();
    setInterval(checkGPUStatus, 5000);
    // Restore saved language ‚Äî always apply to set REWARD_LABELS etc.
    switchLanguage(currentLang);
});
</script>
</body>
</html>
